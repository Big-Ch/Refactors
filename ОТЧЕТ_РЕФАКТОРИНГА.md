# Отчет о рефакторинге проекта OnlineShop

## ИТЕРАЦИЯ 1: Устранение критических уязвимостей и базовых проблем

### Задача 1.1: Рефакторинг конфигурации

**Цель изменения:** Вынести все чувствительные данные (пароли, ключи API) в переменные окружения и заменить абсолютные пути на относительные для обеспечения безопасности и переносимости приложения.

**Измененные файлы:**
- `ShawarmaShop/src/main/resources/application.properties`
- `ShawarmaShop/pom.xml`

**Описание изменений:**

1. **application.properties:**
   - Заменен `spring.datasource.password=12345` на `spring.datasource.password=${DB_PASSWORD:12345}` - пароль БД теперь берется из переменной окружения с fallback значением для разработки
   - Заменен абсолютный путь `upload.path=/C:/Users/vccha/Desktop/labs/refactors/ShawarmaShop/src/main/resources/uploads` на относительный `upload.path=${UPLOAD_PATH:./uploads}` - путь теперь переносимый, можно переопределить через переменную окружения
   - Заменен `spring.mail.username=vezhur2003@gmail.com` на `spring.mail.username=${MAIL_USERNAME:}` - учетные данные email вынесены в переменные окружения
   - Заменен `spring.mail.password=K!-iq62Bv` на `spring.mail.password=${MAIL_PASSWORD:}` - пароль email вынесен в переменные окружения
   - Заменен `recaptcha.secret=6Lc5cLkZAAAAANUjd4--Jx6PioSC_N-9MFKT3PsA` на `recaptcha.secret=${RECAPTCHA_SECRET:}` - секретный ключ reCAPTCHA вынесен в переменные окружения

2. **pom.xml:**
   - Удалена строка `<executable>C:\Program Files\Java\jdk1.8.0_251\bin\javac.exe</executable>` из конфигурации maven-compiler-plugin - теперь используется системный Java компилятор, что делает сборку переносимой

**Цель изменений:**
- **Безопасность:** Конфиденциальные данные больше не хранятся в исходном коде, что предотвращает утечку секретов при коммитах в систему контроля версий
- **Переносимость:** Приложение может быть запущено на любой машине без изменения конфигурации, что упрощает развертывание на серверах и в Docker-контейнерах
- **Гибкость развертывания:** Разные окружения (dev, staging, production) могут использовать разные значения через переменные окружения

**Diff:**

```diff
--- a/ShawarmaShop/src/main/resources/application.properties
+++ b/ShawarmaShop/src/main/resources/application.properties
@@ -1,13 +1,13 @@
 spring.datasource.url=jdbc:postgresql://localhost/shawarma
 spring.datasource.username=postgres
-spring.datasource.password=12345
+spring.datasource.password=${DB_PASSWORD:12345}
 
 spring.jpa.generate-ddl=false
 spring.jpa.show-sql=true
 spring.jpa.properties.hibernate.format_sql=false
 spring.jpa.hibernate.ddl-auto=validate
 spring.flyway.locations=classpath:db/migration
 
 server.error.whitelabel.enabled=false
 
-upload.path=/C:/Users/vccha/Desktop/labs/refactors/ShawarmaShop/src/main/resources/uploads
+upload.path=${UPLOAD_PATH:./uploads}
 
 spring.mail.host=smtp.gmail.com
-spring.mail.username=vezhur2003@gmail.com
-spring.mail.password=K!-iq62Bv
+spring.mail.username=${MAIL_USERNAME:}
+spring.mail.password=${MAIL_PASSWORD:}
 spring.mail.port=465
 spring.mail.protocol=smtps
 spring.mail.properties.mail.smtp.auth=true
 spring.mail.properties.mail.smtp.starttls.enable=true
 mail.debug=false
 
 spring.data.web.pageable.default-page-size=12
 
 recaptcha.url=https://www.google.com/recaptcha/api/siteverify?secret=%s&response=%s
-recaptcha.secret=6Lc5cLkZAAAAANUjd4--Jx6PioSC_N-9MFKT3PsA
+recaptcha.secret=${RECAPTCHA_SECRET:}
 
 hostname=localhost:8080
 
 logging.level.com.gmail.v.c.charkin.gurmanfood.controller=debug
```

```diff
--- a/ShawarmaShop/pom.xml
+++ b/ShawarmaShop/pom.xml
@@ -145,9 +145,7 @@
             <plugin>
                 <artifactId>maven-compiler-plugin</artifactId>
                 <version>3.8.1</version>
                 <configuration>
                     <fork>true</fork>
-                    <executable>C:\Program Files\Java\jdk1.8.0_251\bin\javac.exe</executable>
                 </configuration>
             </plugin>
```

**Результат:** Все конфиденциальные данные вынесены в переменные окружения, пути стали переносимыми. Приложение готово к безопасному развертыванию на любом окружении.

---

### Задача 1.2: Включение CSRF-защиты

**Цель изменения:** Активировать CSRF-защиту в Spring Security для защиты пользователей от межсайтовых подделок запросов.

**Измененные файлы:**
- `ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/configuration/WebSecurityConfiguration.java`
- `ShawarmaShop/src/main/resources/templates/login.html`
- `ShawarmaShop/src/main/resources/templates/registration.html`
- `ShawarmaShop/src/main/resources/templates/fragments/common-fragments.html`
- `ShawarmaShop/src/main/resources/templates/user-info-edit.html`
- `ShawarmaShop/src/main/resources/templates/cart.html`
- `ShawarmaShop/src/main/resources/templates/shawarma.html`
- `ShawarmaShop/src/main/resources/templates/ordering.html`
- `ShawarmaShop/src/main/resources/templates/user-password-reset.html`
- `ShawarmaShop/src/main/resources/templates/reset-password.html`
- `ShawarmaShop/src/main/resources/templates/forgot-password.html`
- `ShawarmaShop/src/main/resources/templates/admin-add-shawarma.html`
- `ShawarmaShop/src/main/resources/templates/admin-edit-shawarma.html`

**Описание изменений:**

1. **WebSecurityConfiguration.java:**
   - Удалена строка `.and().csrf().disable()` (строка 46) - CSRF защита теперь включена по умолчанию в Spring Security

2. **Все HTML формы с POST запросами:**
   - Заменен атрибут `action="/path"` на `th:action="@{/path}"` во всех POST формах
   - Thymeleaf автоматически добавляет CSRF токен в формы при использовании `th:action`
   - Обновлены следующие формы:
     - Логин (`/login`)
     - Регистрация (`/registration`)
     - Выход (`/logout`)
     - Редактирование информации пользователя (`/user/info/edit`)
     - Удаление из корзины (`/cart/remove`)
     - Добавление в корзину (`/cart/add`)
     - Оформление заказа (`/order`)
     - Смена пароля (`/user/change/password`)
     - Сброс пароля (`/auth/reset`)
     - Забыл пароль (`/auth/forgot`)
     - Добавление шаурмы (`/admin/add/shawarma`)
     - Редактирование шаурмы (`/admin/edit/shawarma`)

**Цель изменений:**
- **Безопасность:** CSRF защита предотвращает атаки типа Cross-Site Request Forgery, когда злоумышленник может заставить браузер аутентифицированного пользователя выполнить нежелательные действия без его ведома
- **Соответствие best practices:** Включение CSRF защиты - это базовое требование для безопасного веб-приложения
- **Защита пользователей:** Пользователи защищены от несанкционированных действий, инициированных с других сайтов

**Diff:**

```diff
--- a/ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/configuration/WebSecurityConfiguration.java
+++ b/ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/configuration/WebSecurityConfiguration.java
@@ -43,5 +43,4 @@ public class WebSecurityConfiguration extends WebSecurityConfigurerAdapter {
                 .and()
                     .logout()
                     .permitAll()
-                .and().csrf().disable();
     }
```

Пример замены в формах (на примере login.html):
```diff
--- a/ShawarmaShop/src/main/resources/templates/login.html
+++ b/ShawarmaShop/src/main/resources/templates/login.html
@@ -14,7 +14,7 @@
                 Неверный адрес Электронной Почты или Пароль
             </div>
             <th:block th:replace="fragments/common-fragments :: alert-message"/>
-            <form method="post" action="/login">
+            <form method="post" th:action="@{/login}">
                 <div class="container mt-5">
```

**Результат:** CSRF защита активирована, все POST формы обновлены для поддержки CSRF токенов. Приложение защищено от CSRF атак.

---

### Задача 1.3: Корректная обработка исключений

**Цель изменения:** Заменить использование @SneakyThrows на явную обработку исключений для улучшения предсказуемости и надежности кода.

**Измененные файлы:**
- `ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/impl/AdminServiceImpl.java`
- `ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/AdminService.java`
- `ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/controller/AdminController.java`

**Описание изменений:**

1. **AdminServiceImpl.java:**
   - Удалена аннотация `@SneakyThrows` из метода `editShawarma()` (строка 88)
   - Удалена аннотация `@SneakyThrows` из метода `addShawarma()` (строка 95)
   - Добавлено явное объявление `throws IOException` в сигнатуры методов `editShawarma()` и `addShawarma()`
   - Удален импорт `lombok.SneakyThrows`, так как он больше не используется

2. **AdminService.java (интерфейс):**
   - Добавлен импорт `java.io.IOException`
   - Добавлено `throws IOException` в сигнатуры методов `editShawarma()` и `addShawarma()` для соответствия контракту интерфейса

3. **AdminController.java:**
   - Добавлен импорт `java.io.IOException`
   - Добавлено `throws IOException` в методы `editShawarma()` и `addShawarma()` контроллера
   - Дополнительно: удален отладочный `System.out.println(shawarma);` из метода `addShawarma()` (задача 1.5)

**Цель изменений:**
- **Предсказуемость:** Явное объявление исключений делает поведение метода предсказуемым - разработчик знает, какие ошибки могут произойти
- **Надежность:** Явная обработка заставляет продумывать сценарии сбоев, что делает приложение более стабильным и отказоустойчивым
- **Лучшая читаемость:** Код становится более понятным, так как видно, какие исключения может выбрасывать метод

**Diff:**

```diff
--- a/ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/impl/AdminServiceImpl.java
+++ b/ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/impl/AdminServiceImpl.java
@@ -15,7 +15,6 @@
 import com.gmail.v.c.charkin.gurmanfood.service.AdminService;
 import lombok.RequiredArgsConstructor;
-import lombok.SneakyThrows;
 import org.modelmapper.ModelMapper;
@@ -87,16 +86,14 @@ public class AdminServiceImpl implements AdminService {
     }
 
     @Override
-    @SneakyThrows
     @Transactional
-    public MessageResponse editShawarma(ShawarmaRequest shawarmaRequest, MultipartFile file) {
+    public MessageResponse editShawarma(ShawarmaRequest shawarmaRequest, MultipartFile file) throws IOException {
         return saveShawarma(shawarmaRequest, file, SuccessMessage.SHAWARMA_EDITED);
     }
 
     @Override
-    @SneakyThrows
     @Transactional
-    public MessageResponse addShawarma(ShawarmaRequest shawarmaRequest, MultipartFile file) {
+    public MessageResponse addShawarma(ShawarmaRequest shawarmaRequest, MultipartFile file) throws IOException {
         return saveShawarma(shawarmaRequest, file, SuccessMessage.SHAWARMA_ADDED);
     }
```

```diff
--- a/ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/AdminService.java
+++ b/ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/AdminService.java
@@ -11,6 +11,8 @@
 import org.springframework.data.domain.Pageable;
 import org.springframework.web.multipart.MultipartFile;
 
+import java.io.IOException;
+
 public interface AdminService {
@@ -31,6 +33,6 @@
     Shawarma getShawarmaById(Long shawarmaId);
 
-    MessageResponse editShawarma(ShawarmaRequest shawarmaRequest, MultipartFile file);
+    MessageResponse editShawarma(ShawarmaRequest shawarmaRequest, MultipartFile file) throws IOException;
 
-    MessageResponse addShawarma(ShawarmaRequest shawarmaRequest, MultipartFile file);
+    MessageResponse addShawarma(ShawarmaRequest shawarmaRequest, MultipartFile file) throws IOException;
```

**Результат:** Все исключения обрабатываются явно, улучшена читаемость и предсказуемость кода. Разработчики теперь знают, какие исключения могут быть выброшены методами.

---

### Задача 1.5: Удаление отладочного кода

**Цель изменения:** Удалить System.out.println из production кода для чистоты кода.

**Измененные файлы:**
- `ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/controller/AdminController.java`

**Описание изменений:**

1. **AdminController.java:**
   - Удалена строка `System.out.println(shawarma);` из метода `addShawarma()` (была строка 97)

**Цель изменений:**
- **Чистота кода:** Production код не должен содержать отладочные выводы
- **Профессионализм:** Удаление отладочного кода делает приложение более готовым к production

**Результат:** Production код очищен от отладочных выводов. (Задача выполнена вместе с задачей 1.3)

---

### Задача 1.4: Выделение файлового сервиса (FileService)

**Цель изменения:** Изолировать логику работы с файлами в отдельный сервис для разделения ответственности, переиспользования и улучшения тестируемости.

**Измененные файлы:**
- Создан `ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/FileService.java` (новый интерфейс)
- Создан `ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/impl/FileServiceImpl.java` (новая реализация)
- `ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/impl/AdminServiceImpl.java`

**Описание изменений:**

1. **FileService.java (новый интерфейс):**
   - Создан интерфейс с методами:
     - `String saveFile(MultipartFile file) throws IOException` - сохранение файла с валидацией
     - `void deleteFile(String filename) throws IOException` - удаление файла
     - `boolean fileExists(String filename)` - проверка существования файла
   - Добавлена JavaDoc документация для всех методов

2. **FileServiceImpl.java (новая реализация):**
   - Реализована логика сохранения файлов с валидацией:
     - Проверка размера файла (max 10MB)
     - Проверка типа файла (только изображения: jpg, png, jpeg)
     - Проверка имени файла на безопасность
   - Логика создания директории загрузки с обработкой ошибок
   - Генерация уникальных имен файлов с использованием UUID
   - Добавлено логирование операций (уровень DEBUG)
   - Обработка ошибок с информативными сообщениями

3. **AdminServiceImpl.java:**
   - Удалено поле `uploadPath` и аннотация `@Value("${upload.path}")`
   - Удалены импорты `java.io.File` и `java.util.UUID`
   - Добавлена инжекция `FileService`
   - Метод `saveShawarma()` упрощен:
     - Удалена логика работы с файлами (создание директории, генерация имени, сохранение)
     - Заменено на вызов `fileService.saveFile(file)`
     - Упрощена проверка файла (используется `file.isEmpty()` вместо проверки имени)

**Цель изменений:**
- **Разделение ответственности (Single Responsibility Principle):** Бизнес-сервис больше не занимается техническими деталями файловых операций, код стал чище и понятнее
- **Переиспользование:** FileService может использоваться в других частях приложения
- **Тестируемость:** Файловые операции легко тестировать изолированно от бизнес-логики
- **Безопасность:** Добавлена валидация загружаемых файлов (размер, тип, имя)

**Diff:**

```diff
--- a/ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/impl/AdminServiceImpl.java
+++ b/ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/impl/AdminServiceImpl.java
@@ -12,21 +12,19 @@
 import com.gmail.v.c.charkin.gurmanfood.repository.OrderRepository;
 import com.gmail.v.c.charkin.gurmanfood.repository.ShawarmaRepository;
 import com.gmail.v.c.charkin.gurmanfood.repository.UserRepository;
 import com.gmail.v.c.charkin.gurmanfood.service.AdminService;
+import com.gmail.v.c.charkin.gurmanfood.service.FileService;
 import lombok.RequiredArgsConstructor;
 import org.modelmapper.ModelMapper;
-import org.springframework.beans.factory.annotation.Value;
 import org.springframework.data.domain.Page;
@@ -33,9 +33,8 @@
 @Service
 @RequiredArgsConstructor
 public class AdminServiceImpl implements AdminService {
 
-    @Value("${upload.path}")
-    private String uploadPath;
-
     private final UserRepository userRepository;
     private final ShawarmaRepository shawarmaRepository;
     private final OrderRepository orderRepository;
     private final ModelMapper modelMapper;
+    private final FileService fileService;
@@ -106,17 +105,9 @@
 
     private MessageResponse saveShawarma(ShawarmaRequest shawarmaRequest, MultipartFile file, String message) throws IOException {
         Shawarma shawarma = modelMapper.map(shawarmaRequest, Shawarma.class);
-        if (file != null && !file.getOriginalFilename().isEmpty()) {
-            File uploadDir = new File(uploadPath);
-
-            if (!uploadDir.exists()) {
-                uploadDir.mkdir();
-            }
-            String uuidFile = UUID.randomUUID().toString();
-            String resultFilename = uuidFile + "." + file.getOriginalFilename();
-            file.transferTo(new File(uploadPath + "/" + resultFilename));
+        if (file != null && !file.isEmpty()) {
+            String resultFilename = fileService.saveFile(file);
             shawarma.setFilename(resultFilename);
         }
         shawarmaRepository.save(shawarma);
         return new MessageResponse("alert-success", message);
     }
```

**Результат:** Разделение ответственности достигнуто: бизнес-логика отделена от файловых операций. FileService можно переиспользовать в других частях приложения и легко тестировать.

---

### Задача 1.6: Актуализация работы с JPA

**Цель изменения:** Заменить устаревший метод getOne() на современный и безопасный findById() для предотвращения скрытых ошибок.

**Измененные файлы:**
- `ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/impl/CartServiceImpl.java`

**Описание изменений:**

1. **CartServiceImpl.java:**
   - Добавлены импорты:
     - `com.gmail.v.c.charkin.gurmanfood.constants.ErrorMessage`
     - `org.springframework.http.HttpStatus`
     - `org.springframework.web.server.ResponseStatusException`
   - В методе `addShawarmaToCart()` (строка 31):
     - Заменен `shawarmaRepository.getOne(shawarmaId)` на `shawarmaRepository.findById(shawarmaId).orElseThrow(() -> new ResponseStatusException(HttpStatus.NOT_FOUND, ErrorMessage.SHAWARMA_NOT_FOUND))`
   - В методе `removeShawarmaFromCart()` (строка 39):
     - Заменен `shawarmaRepository.getOne(shawarmaId)` на `shawarmaRepository.findById(shawarmaId).orElseThrow(() -> new ResponseStatusException(HttpStatus.NOT_FOUND, ErrorMessage.SHAWARMA_NOT_FOUND))`

**Цель изменений:**
- **Предотвращение скрытых ошибок:** Метод `getOne()` не выполняет запрос к БД немедленно и может вернуть прокси-объект, что часто приводит к `EntityNotFoundException` в неожиданном месте. `findById()` сразу проверяет наличие сущности
- **Немедленная обработка ошибок:** Позволяет немедленно обработать случай, когда сущность не найдена, делая код более надежным
- **Использование актуальных методов JPA:** `getOne()` помечен как deprecated в более новых версиях JPA

**Diff:**

```diff
--- a/ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/impl/CartServiceImpl.java
+++ b/ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/impl/CartServiceImpl.java
@@ -3,11 +3,15 @@
 import com.gmail.v.c.charkin.gurmanfood.domain.Shawarma;
 import com.gmail.v.c.charkin.gurmanfood.domain.User;
 import com.gmail.v.c.charkin.gurmanfood.repository.ShawarmaRepository;
 import com.gmail.v.c.charkin.gurmanfood.service.CartService;
 import com.gmail.v.c.charkin.gurmanfood.service.UserService;
 import lombok.RequiredArgsConstructor;
+import org.springframework.http.HttpStatus;
 import org.springframework.stereotype.Service;
 import org.springframework.transaction.annotation.Transactional;
+import org.springframework.web.server.ResponseStatusException;
+
+import com.gmail.v.c.charkin.gurmanfood.constants.ErrorMessage;
 
 import java.util.List;
@@ -29,13 +33,15 @@
     @Override
     @Transactional
     public void addShawarmaToCart(Long shawarmaId) {
         User user = userService.getAuthenticatedUser();
-        Shawarma shawarma = shawarmaRepository.getOne(shawarmaId);
+        Shawarma shawarma = shawarmaRepository.findById(shawarmaId)
+                .orElseThrow(() -> new ResponseStatusException(HttpStatus.NOT_FOUND, ErrorMessage.SHAWARMA_NOT_FOUND));
         user.getShawarmaList().add(shawarma);
     }
 
     @Override
     @Transactional
     public void removeShawarmaFromCart(Long shawarmaId) {
         User user = userService.getAuthenticatedUser();
-        Shawarma shawarma = shawarmaRepository.getOne(shawarmaId);
+        Shawarma shawarma = shawarmaRepository.findById(shawarmaId)
+                .orElseThrow(() -> new ResponseStatusException(HttpStatus.NOT_FOUND, ErrorMessage.SHAWARMA_NOT_FOUND));
         user.getShawarmaList().remove(shawarma);
     }
```

**Результат:** Используются актуальные методы JPA, корректно обрабатываются отсутствующие сущности, исключены скрытые ошибки при работе с базой данных.

**ВИДЕО ОТЧЁТ ПО ИТЕРАЦИИ 1:** https://drive.google.com/file/d/1mL-2-CpcVp6bHTa52Y2Dqof5RRgVN8tz/view?usp=sharing

---

## ИТЕРАЦИЯ 2: Улучшение архитектуры и устранение дублирования

### Задача 2.1: Создание GlobalExceptionHandler

**Цель изменения:** Создать централизованный обработчик исключений для единообразной обработки всех ошибок в приложении и улучшения наблюдаемости через логирование.

**Измененные файлы:**
- Создан `ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/exception/GlobalExceptionHandler.java` (новый класс)

**Описание изменений:**

1. **GlobalExceptionHandler.java (новый класс):**
   - Создан класс с аннотацией `@ControllerAdvice` для глобальной обработки исключений
   - Добавлен метод `handleResponseStatusException()` для обработки `ResponseStatusException`:
     - Определяет HTTP статус из исключения
     - Логирует ошибку с уровнем ERROR
     - Возвращает соответствующую страницу ошибки (404 или 500)
     - Передает сообщение об ошибке в модель
   - Добавлен метод `handleIOException()` для обработки ошибок работы с файлами:
     - Логирует ошибку с уровнем ERROR
     - Возвращает страницу 500 с информативным сообщением
   - Добавлен метод `handleException()` как fallback для всех остальных исключений:
     - Логирует неожиданные исключения с уровнем ERROR
     - Возвращает страницу 500 с общим сообщением об ошибке
   - Использован SLF4J Logger для структурированного логирования

**Цель изменений:**
- **Централизация обработки ошибок:** Все исключения обрабатываются в одном месте, что упрощает поддержку и изменение логики обработки ошибок
- **Единообразие:** Все ошибки обрабатываются одинаково, пользователи получают консистентный опыт
- **Наблюдаемость:** Все исключения логируются, что упрощает отладку и мониторинг приложения
- **Улучшение пользовательского опыта:** Пользователи получают понятные сообщения об ошибках вместо технических деталей

**Diff:**

```diff
--- /dev/null
+++ b/ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/exception/GlobalExceptionHandler.java
@@ -0,0 +1,66 @@
+package com.gmail.v.c.charkin.gurmanfood.exception;
+
+import com.gmail.v.c.charkin.gurmanfood.constants.Pages;
+import org.slf4j.Logger;
+import org.slf4j.LoggerFactory;
+import org.springframework.http.HttpStatus;
+import org.springframework.ui.Model;
+import org.springframework.web.bind.annotation.ControllerAdvice;
+import org.springframework.web.bind.annotation.ExceptionHandler;
+import org.springframework.web.server.ResponseStatusException;
+
+import java.io.IOException;
+
+/**
+ * Глобальный обработчик исключений для всего приложения.
+ * Обеспечивает централизованную обработку всех исключений и единообразный формат ответов.
+ */
+@ControllerAdvice
+public class GlobalExceptionHandler {
+
+    private static final Logger logger = LoggerFactory.getLogger(GlobalExceptionHandler.class);
+
+    /**
+     * Обрабатывает ResponseStatusException - исключения с HTTP статусами.
+     *
+     * @param ex исключение
+     * @param model модель для передачи данных в представление
+     * @return имя представления для отображения ошибки
+     */
+    @ExceptionHandler(ResponseStatusException.class)
+    public String handleResponseStatusException(ResponseStatusException ex, Model model) {
+        logger.error("ResponseStatusException occurred: {}", ex.getMessage(), ex);
+        
+        HttpStatus status = ex.getStatus();
+        String errorMessage = ex.getReason() != null ? ex.getReason() : ex.getMessage();
+        
+        model.addAttribute("errorMessage", errorMessage);
+        
+        if (status == HttpStatus.NOT_FOUND) {
+            return Pages.ERROR_404;
+        }
+        
+        return Pages.ERROR_500;
+    }
+
+    /**
+     * Обрабатывает IOException - ошибки работы с файлами.
+     *
+     * @param ex исключение
+     * @param model модель для передачи данных в представление
+     * @return имя представления для отображения ошибки
+     */
+    @ExceptionHandler(IOException.class)
+    public String handleIOException(IOException ex, Model model) {
+        logger.error("IOException occurred: {}", ex.getMessage(), ex);
+        model.addAttribute("errorMessage", "File operation error: " + ex.getMessage());
+        return Pages.ERROR_500;
+    }
+
+    /**
+     * Обрабатывает все остальные исключения (fallback).
+     *
+     * @param ex исключение
+     * @param model модель для передачи данных в представление
+     * @return имя представления для отображения ошибки
+     */
+    @ExceptionHandler(Exception.class)
+    public String handleException(Exception ex, Model model) {
+        logger.error("Unexpected exception occurred: {}", ex.getMessage(), ex);
+        model.addAttribute("errorMessage", "An unexpected error occurred. Please try again later.");
+        return Pages.ERROR_500;
+    }
+}
```

**Результат:** Создан централизованный обработчик исключений. Все исключения теперь обрабатываются единообразно, логируются для отладки и мониторинга, пользователи получают понятные сообщения об ошибках.

---

### Задача 2.2: Внедрение кастомных исключений

**Цель изменения:** Создать иерархию кастомных исключений для более явной и понятной обработки ошибок, заменяя использование `ResponseStatusException` на специализированные исключения.

**Измененные файлы:**
- Создан `ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/exception/BusinessLogicException.java` (новый класс)
- Создан `ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/exception/EntityNotFoundException.java` (новый класс)
- Создан `ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/exception/ValidationException.java` (новый класс)
- Создан `ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/exception/FileUploadException.java` (новый класс)
- `ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/exception/GlobalExceptionHandler.java`
- `ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/impl/CartServiceImpl.java`
- `ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/impl/ShawarmaServiceImpl.java`
- `ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/impl/OrderServiceImpl.java`
- `ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/impl/AdminServiceImpl.java`
- `ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/impl/AuthenticationServiceImpl.java`

**Описание изменений:**

1. **Создана иерархия кастомных исключений:**
   - **BusinessLogicException** - базовое исключение для бизнес-логических ошибок (extends RuntimeException)
   - **EntityNotFoundException** - исключение для случаев, когда сущность не найдена (extends BusinessLogicException, автоматически преобразуется в HTTP 404)
   - **ValidationException** - исключение для ошибок валидации данных (extends BusinessLogicException)
   - **FileUploadException** - исключение для ошибок загрузки файлов (extends IOException)

2. **Обновлен GlobalExceptionHandler:**
   - Добавлен метод `handleEntityNotFoundException()` - обрабатывает EntityNotFoundException, возвращает страницу 404
   - Добавлен метод `handleFileUploadException()` - обрабатывает FileUploadException, возвращает страницу 500
   - Добавлен метод `handleValidationException()` - обрабатывает ValidationException, возвращает страницу 500
   - Добавлен метод `handleBusinessLogicException()` - обрабатывает общие бизнес-логические ошибки, возвращает страницу 500
   - Обработчики упорядочены по специфичности (от более специфичных к общим)

3. **Заменены ResponseStatusException на EntityNotFoundException в сервисах:**
   - **CartServiceImpl:** заменены 2 использования ResponseStatusException для SHAWARMA_NOT_FOUND
   - **ShawarmaServiceImpl:** заменено использование ResponseStatusException для SHAWARMA_NOT_FOUND
   - **OrderServiceImpl:** заменено использование ResponseStatusException для ORDER_NOT_FOUND
   - **AdminServiceImpl:** заменены 3 использования ResponseStatusException для ORDER_NOT_FOUND, SHAWARMA_NOT_FOUND, USER_NOT_FOUND
   - **AuthenticationServiceImpl:** заменено использование ResponseStatusException для INVALID_PASSWORD_CODE
   - Удалены импорты `org.springframework.http.HttpStatus` и `org.springframework.web.server.ResponseStatusException`
   - Добавлены импорты `com.gmail.v.c.charkin.gurmanfood.exception.EntityNotFoundException`

**Цель изменений:**
- **Семантическая ясность:** Кастомные исключения явно показывают тип ошибки (сущность не найдена, ошибка валидации, ошибка загрузки файла), что делает код более читаемым и понятным
- **Типобезопасность:** Использование специализированных исключений позволяет компилятору и IDE лучше отслеживать обработку ошибок
- **Расширяемость:** Иерархия исключений позволяет легко добавлять новые типы ошибок и их обработку
- **Разделение ответственности:** Разные типы исключений обрабатываются по-разному, что позволяет более точно контролировать поведение приложения
- **Улучшение тестируемости:** Кастомные исключения легче тестировать и мокировать

**Diff:**

```diff
--- /dev/null
+++ b/ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/exception/BusinessLogicException.java
@@ -0,0 +1,15 @@
+package com.gmail.v.c.charkin.gurmanfood.exception;
+
+/**
+ * Базовое исключение для бизнес-логических ошибок приложения.
+ * Используется для обработки ошибок, связанных с бизнес-правилами.
+ */
+public class BusinessLogicException extends RuntimeException {
+
+    public BusinessLogicException(String message) {
+        super(message);
+    }
+
+    public BusinessLogicException(String message, Throwable cause) {
+        super(message, cause);
+    }
+}
```

```diff
--- /dev/null
+++ b/ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/exception/EntityNotFoundException.java
@@ -0,0 +1,29 @@
+package com.gmail.v.c.charkin.gurmanfood.exception;
+
+import org.springframework.http.HttpStatus;
+import org.springframework.web.server.ResponseStatusException;
+
+/**
+ * Исключение, выбрасываемое когда запрашиваемая сущность не найдена в базе данных.
+ * Автоматически преобразуется в HTTP 404 статус.
+ */
+public class EntityNotFoundException extends BusinessLogicException {
+
+    private final HttpStatus status;
+
+    public EntityNotFoundException(String message) {
+        super(message);
+        this.status = HttpStatus.NOT_FOUND;
+    }
+
+    /**
+     * Преобразует исключение в ResponseStatusException для совместимости с существующим кодом.
+     *
+     * @return ResponseStatusException с HTTP 404 статусом
+     */
+    public ResponseStatusException toResponseStatusException() {
+        return new ResponseStatusException(status, getMessage());
+    }
+
+    public HttpStatus getStatus() {
+        return status;
+    }
+}
```

```diff
--- /dev/null
+++ b/ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/exception/ValidationException.java
@@ -0,0 +1,17 @@
+package com.gmail.v.c.charkin.gurmanfood.exception;
+
+/**
+ * Исключение, выбрасываемое при ошибках валидации данных.
+ * Используется для обработки ошибок валидации входных данных.
+ */
+public class ValidationException extends BusinessLogicException {
+
+    public ValidationException(String message) {
+        super(message);
+    }
+
+    public ValidationException(String message, Throwable cause) {
+        super(message, cause);
+    }
+}
```

```diff
--- /dev/null
+++ b/ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/exception/FileUploadException.java
@@ -0,0 +1,17 @@
+package com.gmail.v.c.charkin.gurmanfood.exception;
+
+import java.io.IOException;
+
+/**
+ * Исключение, выбрасываемое при ошибках загрузки или обработки файлов.
+ * Расширяет IOException для совместимости с существующим кодом.
+ */
+public class FileUploadException extends IOException {
+
+    public FileUploadException(String message) {
+        super(message);
+    }
+
+    public FileUploadException(String message, Throwable cause) {
+        super(message, cause);
+    }
+}
```

```diff
--- a/ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/exception/GlobalExceptionHandler.java
+++ b/ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/exception/GlobalExceptionHandler.java
@@ -23,6 +23,50 @@
     private static final Logger logger = LoggerFactory.getLogger(GlobalExceptionHandler.class);
 
     /**
+     * Обрабатывает EntityNotFoundException - когда сущность не найдена.
+     *
+     * @param ex исключение
+     * @param model модель для передачи данных в представление
+     * @return имя представления для отображения ошибки
+     */
+    @ExceptionHandler(EntityNotFoundException.class)
+    public String handleEntityNotFoundException(EntityNotFoundException ex, Model model) {
+        logger.error("EntityNotFoundException occurred: {}", ex.getMessage(), ex);
+        model.addAttribute("errorMessage", ex.getMessage());
+        return Pages.ERROR_404;
+    }
+
+    /**
+     * Обрабатывает FileUploadException - ошибки загрузки файлов.
+     *
+     * @param ex исключение
+     * @param model модель для передачи данных в представление
+     * @return имя представления для отображения ошибки
+     */
+    @ExceptionHandler(FileUploadException.class)
+    public String handleFileUploadException(FileUploadException ex, Model model) {
+        logger.error("FileUploadException occurred: {}", ex.getMessage(), ex);
+        model.addAttribute("errorMessage", "File upload error: " + ex.getMessage());
+        return Pages.ERROR_500;
+    }
+
+    /**
+     * Обрабатывает ValidationException - ошибки валидации данных.
+     *
+     * @param ex исключение
+     * @param model модель для передачи данных в представление
+     * @return имя представления для отображения ошибки
+     */
+    @ExceptionHandler(ValidationException.class)
+    public String handleValidationException(ValidationException ex, Model model) {
+        logger.warn("ValidationException occurred: {}", ex.getMessage(), ex);
+        model.addAttribute("errorMessage", "Validation error: " + ex.getMessage());
+        return Pages.ERROR_500;
+    }
+
+    /**
+     * Обрабатывает BusinessLogicException - общие бизнес-логические ошибки.
+     *
+     * @param ex исключение
+     * @param model модель для передачи данных в представление
+     * @return имя представления для отображения ошибки
+     */
+    @ExceptionHandler(BusinessLogicException.class)
+    public String handleBusinessLogicException(BusinessLogicException ex, Model model) {
+        logger.error("BusinessLogicException occurred: {}", ex.getMessage(), ex);
+        model.addAttribute("errorMessage", ex.getMessage());
+        return Pages.ERROR_500;
+    }
+
+    /**
      * Обрабатывает ResponseStatusException - исключения с HTTP статусами.
      * Оставлен для обратной совместимости с существующим кодом.
      *
@@ -45,6 +89,8 @@
 
     /**
      * Обрабатывает IOException - ошибки работы с файлами.
+     * Обрабатывает только IOException, которые не являются FileUploadException.
      *
      * @param ex исключение
      * @param model модель для передачи данных в представление
```

Пример замены в сервисах (на примере CartServiceImpl):
```diff
--- a/ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/impl/CartServiceImpl.java
+++ b/ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/impl/CartServiceImpl.java
@@ -3,13 +3,12 @@
 import com.gmail.v.c.charkin.gurmanfood.constants.ErrorMessage;
 import com.gmail.v.c.charkin.gurmanfood.domain.Shawarma;
 import com.gmail.v.c.charkin.gurmanfood.domain.User;
+import com.gmail.v.c.charkin.gurmanfood.exception.EntityNotFoundException;
 import com.gmail.v.c.charkin.gurmanfood.repository.ShawarmaRepository;
 import com.gmail.v.c.charkin.gurmanfood.service.CartService;
 import com.gmail.v.c.charkin.gurmanfood.service.UserService;
 import lombok.RequiredArgsConstructor;
-import org.springframework.http.HttpStatus;
 import org.springframework.stereotype.Service;
 import org.springframework.transaction.annotation.Transactional;
-import org.springframework.web.server.ResponseStatusException;
 
 import java.util.List;
@@ -33,7 +32,7 @@
     public void addShawarmaToCart(Long shawarmaId) {
         User user = userService.getAuthenticatedUser();
         Shawarma shawarma = shawarmaRepository.findById(shawarmaId)
-                .orElseThrow(() -> new ResponseStatusException(HttpStatus.NOT_FOUND, ErrorMessage.SHAWARMA_NOT_FOUND));
+                .orElseThrow(() -> new EntityNotFoundException(ErrorMessage.SHAWARMA_NOT_FOUND));
         user.getShawarmaList().add(shawarma);
     }
 
@@ -42,7 +41,7 @@
     public void removeShawarmaFromCart(Long shawarmaId) {
         User user = userService.getAuthenticatedUser();
         Shawarma shawarma = shawarmaRepository.findById(shawarmaId)
-                .orElseThrow(() -> new ResponseStatusException(HttpStatus.NOT_FOUND, ErrorMessage.SHAWARMA_NOT_FOUND));
+                .orElseThrow(() -> new EntityNotFoundException(ErrorMessage.SHAWARMA_NOT_FOUND));
         user.getShawarmaList().remove(shawarma);
     }
 }
```

**Результат:** Создана иерархия кастомных исключений. Все случаи "сущность не найдена" теперь используют `EntityNotFoundException` вместо `ResponseStatusException`, что делает код более семантически понятным и типобезопасным. Глобальный обработчик исключений обрабатывает все типы кастомных исключений с соответствующими HTTP статусами и логированием.