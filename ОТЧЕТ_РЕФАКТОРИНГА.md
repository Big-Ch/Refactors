# Отчет о рефакторинге проекта OnlineShop

## ИТЕРАЦИЯ 1: Устранение критических уязвимостей и базовых проблем

### Задача 1.1: Рефакторинг конфигурации

**Цель изменения:** Вынести все чувствительные данные (пароли, ключи API) в переменные окружения и заменить абсолютные пути на относительные для обеспечения безопасности и переносимости приложения.

**Измененные файлы:**
- `ShawarmaShop/src/main/resources/application.properties`
- `ShawarmaShop/pom.xml`

**Описание изменений:**

1. **application.properties:**
   - Заменен `spring.datasource.password=12345` на `spring.datasource.password=${DB_PASSWORD:12345}` - пароль БД теперь берется из переменной окружения с fallback значением для разработки
   - Заменен абсолютный путь `upload.path=/C:/Users/vccha/Desktop/labs/refactors/ShawarmaShop/src/main/resources/uploads` на относительный `upload.path=${UPLOAD_PATH:./uploads}` - путь теперь переносимый, можно переопределить через переменную окружения
   - Заменен `spring.mail.username=vezhur2003@gmail.com` на `spring.mail.username=${MAIL_USERNAME:}` - учетные данные email вынесены в переменные окружения
   - Заменен `spring.mail.password=K!-iq62Bv` на `spring.mail.password=${MAIL_PASSWORD:}` - пароль email вынесен в переменные окружения
   - Заменен `recaptcha.secret=6Lc5cLkZAAAAANUjd4--Jx6PioSC_N-9MFKT3PsA` на `recaptcha.secret=${RECAPTCHA_SECRET:}` - секретный ключ reCAPTCHA вынесен в переменные окружения

2. **pom.xml:**
   - Удалена строка `<executable>C:\Program Files\Java\jdk1.8.0_251\bin\javac.exe</executable>` из конфигурации maven-compiler-plugin - теперь используется системный Java компилятор, что делает сборку переносимой

**Цель изменений:**
- **Безопасность:** Конфиденциальные данные больше не хранятся в исходном коде, что предотвращает утечку секретов при коммитах в систему контроля версий
- **Переносимость:** Приложение может быть запущено на любой машине без изменения конфигурации, что упрощает развертывание на серверах и в Docker-контейнерах
- **Гибкость развертывания:** Разные окружения (dev, staging, production) могут использовать разные значения через переменные окружения

**Diff:**

```diff
--- a/ShawarmaShop/src/main/resources/application.properties
+++ b/ShawarmaShop/src/main/resources/application.properties
@@ -1,13 +1,13 @@
 spring.datasource.url=jdbc:postgresql://localhost/shawarma
 spring.datasource.username=postgres
-spring.datasource.password=12345
+spring.datasource.password=${DB_PASSWORD:12345}
 
 spring.jpa.generate-ddl=false
 spring.jpa.show-sql=true
 spring.jpa.properties.hibernate.format_sql=false
 spring.jpa.hibernate.ddl-auto=validate
 spring.flyway.locations=classpath:db/migration
 
 server.error.whitelabel.enabled=false
 
-upload.path=/C:/Users/vccha/Desktop/labs/refactors/ShawarmaShop/src/main/resources/uploads
+upload.path=${UPLOAD_PATH:./uploads}
 
 spring.mail.host=smtp.gmail.com
-spring.mail.username=vezhur2003@gmail.com
-spring.mail.password=K!-iq62Bv
+spring.mail.username=${MAIL_USERNAME:}
+spring.mail.password=${MAIL_PASSWORD:}
 spring.mail.port=465
 spring.mail.protocol=smtps
 spring.mail.properties.mail.smtp.auth=true
 spring.mail.properties.mail.smtp.starttls.enable=true
 mail.debug=false
 
 spring.data.web.pageable.default-page-size=12
 
 recaptcha.url=https://www.google.com/recaptcha/api/siteverify?secret=%s&response=%s
-recaptcha.secret=6Lc5cLkZAAAAANUjd4--Jx6PioSC_N-9MFKT3PsA
+recaptcha.secret=${RECAPTCHA_SECRET:}
 
 hostname=localhost:8080
 
 logging.level.com.gmail.v.c.charkin.gurmanfood.controller=debug
```

```diff
--- a/ShawarmaShop/pom.xml
+++ b/ShawarmaShop/pom.xml
@@ -145,9 +145,7 @@
             <plugin>
                 <artifactId>maven-compiler-plugin</artifactId>
                 <version>3.8.1</version>
                 <configuration>
                     <fork>true</fork>
-                    <executable>C:\Program Files\Java\jdk1.8.0_251\bin\javac.exe</executable>
                 </configuration>
             </plugin>
```

**Результат:** Все конфиденциальные данные вынесены в переменные окружения, пути стали переносимыми. Приложение готово к безопасному развертыванию на любом окружении.

---

### Задача 1.2: Включение CSRF-защиты

**Цель изменения:** Активировать CSRF-защиту в Spring Security для защиты пользователей от межсайтовых подделок запросов.

**Измененные файлы:**
- `ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/configuration/WebSecurityConfiguration.java`
- `ShawarmaShop/src/main/resources/templates/login.html`
- `ShawarmaShop/src/main/resources/templates/registration.html`
- `ShawarmaShop/src/main/resources/templates/fragments/common-fragments.html`
- `ShawarmaShop/src/main/resources/templates/user-info-edit.html`
- `ShawarmaShop/src/main/resources/templates/cart.html`
- `ShawarmaShop/src/main/resources/templates/shawarma.html`
- `ShawarmaShop/src/main/resources/templates/ordering.html`
- `ShawarmaShop/src/main/resources/templates/user-password-reset.html`
- `ShawarmaShop/src/main/resources/templates/reset-password.html`
- `ShawarmaShop/src/main/resources/templates/forgot-password.html`
- `ShawarmaShop/src/main/resources/templates/admin-add-shawarma.html`
- `ShawarmaShop/src/main/resources/templates/admin-edit-shawarma.html`

**Описание изменений:**

1. **WebSecurityConfiguration.java:**
   - Удалена строка `.and().csrf().disable()` (строка 46) - CSRF защита теперь включена по умолчанию в Spring Security

2. **Все HTML формы с POST запросами:**
   - Заменен атрибут `action="/path"` на `th:action="@{/path}"` во всех POST формах
   - Thymeleaf автоматически добавляет CSRF токен в формы при использовании `th:action`
   - Обновлены следующие формы:
     - Логин (`/login`)
     - Регистрация (`/registration`)
     - Выход (`/logout`)
     - Редактирование информации пользователя (`/user/info/edit`)
     - Удаление из корзины (`/cart/remove`)
     - Добавление в корзину (`/cart/add`)
     - Оформление заказа (`/order`)
     - Смена пароля (`/user/change/password`)
     - Сброс пароля (`/auth/reset`)
     - Забыл пароль (`/auth/forgot`)
     - Добавление шаурмы (`/admin/add/shawarma`)
     - Редактирование шаурмы (`/admin/edit/shawarma`)

**Цель изменений:**
- **Безопасность:** CSRF защита предотвращает атаки типа Cross-Site Request Forgery, когда злоумышленник может заставить браузер аутентифицированного пользователя выполнить нежелательные действия без его ведома
- **Соответствие best practices:** Включение CSRF защиты - это базовое требование для безопасного веб-приложения
- **Защита пользователей:** Пользователи защищены от несанкционированных действий, инициированных с других сайтов

**Diff:**

```diff
--- a/ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/configuration/WebSecurityConfiguration.java
+++ b/ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/configuration/WebSecurityConfiguration.java
@@ -43,5 +43,4 @@ public class WebSecurityConfiguration extends WebSecurityConfigurerAdapter {
                 .and()
                     .logout()
                     .permitAll()
-                .and().csrf().disable();
     }
```

Пример замены в формах (на примере login.html):
```diff
--- a/ShawarmaShop/src/main/resources/templates/login.html
+++ b/ShawarmaShop/src/main/resources/templates/login.html
@@ -14,7 +14,7 @@
                 Неверный адрес Электронной Почты или Пароль
             </div>
             <th:block th:replace="fragments/common-fragments :: alert-message"/>
-            <form method="post" action="/login">
+            <form method="post" th:action="@{/login}">
                 <div class="container mt-5">
```

**Результат:** CSRF защита активирована, все POST формы обновлены для поддержки CSRF токенов. Приложение защищено от CSRF атак.

---

### Задача 1.3: Корректная обработка исключений

**Цель изменения:** Заменить использование @SneakyThrows на явную обработку исключений для улучшения предсказуемости и надежности кода.

**Измененные файлы:**
- `ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/impl/AdminServiceImpl.java`
- `ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/AdminService.java`
- `ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/controller/AdminController.java`

**Описание изменений:**

1. **AdminServiceImpl.java:**
   - Удалена аннотация `@SneakyThrows` из метода `editShawarma()` (строка 88)
   - Удалена аннотация `@SneakyThrows` из метода `addShawarma()` (строка 95)
   - Добавлено явное объявление `throws IOException` в сигнатуры методов `editShawarma()` и `addShawarma()`
   - Удален импорт `lombok.SneakyThrows`, так как он больше не используется

2. **AdminService.java (интерфейс):**
   - Добавлен импорт `java.io.IOException`
   - Добавлено `throws IOException` в сигнатуры методов `editShawarma()` и `addShawarma()` для соответствия контракту интерфейса

3. **AdminController.java:**
   - Добавлен импорт `java.io.IOException`
   - Добавлено `throws IOException` в методы `editShawarma()` и `addShawarma()` контроллера
   - Дополнительно: удален отладочный `System.out.println(shawarma);` из метода `addShawarma()` (задача 1.5)

**Цель изменений:**
- **Предсказуемость:** Явное объявление исключений делает поведение метода предсказуемым - разработчик знает, какие ошибки могут произойти
- **Надежность:** Явная обработка заставляет продумывать сценарии сбоев, что делает приложение более стабильным и отказоустойчивым
- **Лучшая читаемость:** Код становится более понятным, так как видно, какие исключения может выбрасывать метод

**Diff:**

```diff
--- a/ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/impl/AdminServiceImpl.java
+++ b/ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/impl/AdminServiceImpl.java
@@ -15,7 +15,6 @@
 import com.gmail.v.c.charkin.gurmanfood.service.AdminService;
 import lombok.RequiredArgsConstructor;
-import lombok.SneakyThrows;
 import org.modelmapper.ModelMapper;
@@ -87,16 +86,14 @@ public class AdminServiceImpl implements AdminService {
     }
 
     @Override
-    @SneakyThrows
     @Transactional
-    public MessageResponse editShawarma(ShawarmaRequest shawarmaRequest, MultipartFile file) {
+    public MessageResponse editShawarma(ShawarmaRequest shawarmaRequest, MultipartFile file) throws IOException {
         return saveShawarma(shawarmaRequest, file, SuccessMessage.SHAWARMA_EDITED);
     }
 
     @Override
-    @SneakyThrows
     @Transactional
-    public MessageResponse addShawarma(ShawarmaRequest shawarmaRequest, MultipartFile file) {
+    public MessageResponse addShawarma(ShawarmaRequest shawarmaRequest, MultipartFile file) throws IOException {
         return saveShawarma(shawarmaRequest, file, SuccessMessage.SHAWARMA_ADDED);
     }
```

```diff
--- a/ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/AdminService.java
+++ b/ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/AdminService.java
@@ -11,6 +11,8 @@
 import org.springframework.data.domain.Pageable;
 import org.springframework.web.multipart.MultipartFile;
 
+import java.io.IOException;
+
 public interface AdminService {
@@ -31,6 +33,6 @@
     Shawarma getShawarmaById(Long shawarmaId);
 
-    MessageResponse editShawarma(ShawarmaRequest shawarmaRequest, MultipartFile file);
+    MessageResponse editShawarma(ShawarmaRequest shawarmaRequest, MultipartFile file) throws IOException;
 
-    MessageResponse addShawarma(ShawarmaRequest shawarmaRequest, MultipartFile file);
+    MessageResponse addShawarma(ShawarmaRequest shawarmaRequest, MultipartFile file) throws IOException;
```

**Результат:** Все исключения обрабатываются явно, улучшена читаемость и предсказуемость кода. Разработчики теперь знают, какие исключения могут быть выброшены методами.

---

### Задача 1.5: Удаление отладочного кода

**Цель изменения:** Удалить System.out.println из production кода для чистоты кода.

**Измененные файлы:**
- `ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/controller/AdminController.java`

**Описание изменений:**

1. **AdminController.java:**
   - Удалена строка `System.out.println(shawarma);` из метода `addShawarma()` (была строка 97)

**Цель изменений:**
- **Чистота кода:** Production код не должен содержать отладочные выводы
- **Профессионализм:** Удаление отладочного кода делает приложение более готовым к production

**Результат:** Production код очищен от отладочных выводов. (Задача выполнена вместе с задачей 1.3)

---

### Задача 1.4: Выделение файлового сервиса (FileService)

**Цель изменения:** Изолировать логику работы с файлами в отдельный сервис для разделения ответственности, переиспользования и улучшения тестируемости.

**Измененные файлы:**
- Создан `ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/FileService.java` (новый интерфейс)
- Создан `ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/impl/FileServiceImpl.java` (новая реализация)
- `ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/impl/AdminServiceImpl.java`

**Описание изменений:**

1. **FileService.java (новый интерфейс):**
   - Создан интерфейс с методами:
     - `String saveFile(MultipartFile file) throws IOException` - сохранение файла с валидацией
     - `void deleteFile(String filename) throws IOException` - удаление файла
     - `boolean fileExists(String filename)` - проверка существования файла
   - Добавлена JavaDoc документация для всех методов

2. **FileServiceImpl.java (новая реализация):**
   - Реализована логика сохранения файлов с валидацией:
     - Проверка размера файла (max 10MB)
     - Проверка типа файла (только изображения: jpg, png, jpeg)
     - Проверка имени файла на безопасность
   - Логика создания директории загрузки с обработкой ошибок
   - Генерация уникальных имен файлов с использованием UUID
   - Добавлено логирование операций (уровень DEBUG)
   - Обработка ошибок с информативными сообщениями

3. **AdminServiceImpl.java:**
   - Удалено поле `uploadPath` и аннотация `@Value("${upload.path}")`
   - Удалены импорты `java.io.File` и `java.util.UUID`
   - Добавлена инжекция `FileService`
   - Метод `saveShawarma()` упрощен:
     - Удалена логика работы с файлами (создание директории, генерация имени, сохранение)
     - Заменено на вызов `fileService.saveFile(file)`
     - Упрощена проверка файла (используется `file.isEmpty()` вместо проверки имени)

**Цель изменений:**
- **Разделение ответственности (Single Responsibility Principle):** Бизнес-сервис больше не занимается техническими деталями файловых операций, код стал чище и понятнее
- **Переиспользование:** FileService может использоваться в других частях приложения
- **Тестируемость:** Файловые операции легко тестировать изолированно от бизнес-логики
- **Безопасность:** Добавлена валидация загружаемых файлов (размер, тип, имя)

**Diff:**

```diff
--- a/ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/impl/AdminServiceImpl.java
+++ b/ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/impl/AdminServiceImpl.java
@@ -12,21 +12,19 @@
 import com.gmail.v.c.charkin.gurmanfood.repository.OrderRepository;
 import com.gmail.v.c.charkin.gurmanfood.repository.ShawarmaRepository;
 import com.gmail.v.c.charkin.gurmanfood.repository.UserRepository;
 import com.gmail.v.c.charkin.gurmanfood.service.AdminService;
+import com.gmail.v.c.charkin.gurmanfood.service.FileService;
 import lombok.RequiredArgsConstructor;
 import org.modelmapper.ModelMapper;
-import org.springframework.beans.factory.annotation.Value;
 import org.springframework.data.domain.Page;
@@ -33,9 +33,8 @@
 @Service
 @RequiredArgsConstructor
 public class AdminServiceImpl implements AdminService {
 
-    @Value("${upload.path}")
-    private String uploadPath;
-
     private final UserRepository userRepository;
     private final ShawarmaRepository shawarmaRepository;
     private final OrderRepository orderRepository;
     private final ModelMapper modelMapper;
+    private final FileService fileService;
@@ -106,17 +105,9 @@
 
     private MessageResponse saveShawarma(ShawarmaRequest shawarmaRequest, MultipartFile file, String message) throws IOException {
         Shawarma shawarma = modelMapper.map(shawarmaRequest, Shawarma.class);
-        if (file != null && !file.getOriginalFilename().isEmpty()) {
-            File uploadDir = new File(uploadPath);
-
-            if (!uploadDir.exists()) {
-                uploadDir.mkdir();
-            }
-            String uuidFile = UUID.randomUUID().toString();
-            String resultFilename = uuidFile + "." + file.getOriginalFilename();
-            file.transferTo(new File(uploadPath + "/" + resultFilename));
+        if (file != null && !file.isEmpty()) {
+            String resultFilename = fileService.saveFile(file);
             shawarma.setFilename(resultFilename);
         }
         shawarmaRepository.save(shawarma);
         return new MessageResponse("alert-success", message);
     }
```

**Результат:** Разделение ответственности достигнуто: бизнес-логика отделена от файловых операций. FileService можно переиспользовать в других частях приложения и легко тестировать.

---

### Задача 1.6: Актуализация работы с JPA

**Цель изменения:** Заменить устаревший метод getOne() на современный и безопасный findById() для предотвращения скрытых ошибок.

**Измененные файлы:**
- `ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/impl/CartServiceImpl.java`

**Описание изменений:**

1. **CartServiceImpl.java:**
   - Добавлены импорты:
     - `com.gmail.v.c.charkin.gurmanfood.constants.ErrorMessage`
     - `org.springframework.http.HttpStatus`
     - `org.springframework.web.server.ResponseStatusException`
   - В методе `addShawarmaToCart()` (строка 31):
     - Заменен `shawarmaRepository.getOne(shawarmaId)` на `shawarmaRepository.findById(shawarmaId).orElseThrow(() -> new ResponseStatusException(HttpStatus.NOT_FOUND, ErrorMessage.SHAWARMA_NOT_FOUND))`
   - В методе `removeShawarmaFromCart()` (строка 39):
     - Заменен `shawarmaRepository.getOne(shawarmaId)` на `shawarmaRepository.findById(shawarmaId).orElseThrow(() -> new ResponseStatusException(HttpStatus.NOT_FOUND, ErrorMessage.SHAWARMA_NOT_FOUND))`

**Цель изменений:**
- **Предотвращение скрытых ошибок:** Метод `getOne()` не выполняет запрос к БД немедленно и может вернуть прокси-объект, что часто приводит к `EntityNotFoundException` в неожиданном месте. `findById()` сразу проверяет наличие сущности
- **Немедленная обработка ошибок:** Позволяет немедленно обработать случай, когда сущность не найдена, делая код более надежным
- **Использование актуальных методов JPA:** `getOne()` помечен как deprecated в более новых версиях JPA

**Diff:**

```diff
--- a/ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/impl/CartServiceImpl.java
+++ b/ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/impl/CartServiceImpl.java
@@ -3,11 +3,15 @@
 import com.gmail.v.c.charkin.gurmanfood.domain.Shawarma;
 import com.gmail.v.c.charkin.gurmanfood.domain.User;
 import com.gmail.v.c.charkin.gurmanfood.repository.ShawarmaRepository;
 import com.gmail.v.c.charkin.gurmanfood.service.CartService;
 import com.gmail.v.c.charkin.gurmanfood.service.UserService;
 import lombok.RequiredArgsConstructor;
+import org.springframework.http.HttpStatus;
 import org.springframework.stereotype.Service;
 import org.springframework.transaction.annotation.Transactional;
+import org.springframework.web.server.ResponseStatusException;
+
+import com.gmail.v.c.charkin.gurmanfood.constants.ErrorMessage;
 
 import java.util.List;
@@ -29,13 +33,15 @@
     @Override
     @Transactional
     public void addShawarmaToCart(Long shawarmaId) {
         User user = userService.getAuthenticatedUser();
-        Shawarma shawarma = shawarmaRepository.getOne(shawarmaId);
+        Shawarma shawarma = shawarmaRepository.findById(shawarmaId)
+                .orElseThrow(() -> new ResponseStatusException(HttpStatus.NOT_FOUND, ErrorMessage.SHAWARMA_NOT_FOUND));
         user.getShawarmaList().add(shawarma);
     }
 
     @Override
     @Transactional
     public void removeShawarmaFromCart(Long shawarmaId) {
         User user = userService.getAuthenticatedUser();
-        Shawarma shawarma = shawarmaRepository.getOne(shawarmaId);
+        Shawarma shawarma = shawarmaRepository.findById(shawarmaId)
+                .orElseThrow(() -> new ResponseStatusException(HttpStatus.NOT_FOUND, ErrorMessage.SHAWARMA_NOT_FOUND));
         user.getShawarmaList().remove(shawarma);
     }
```

**Результат:** Используются актуальные методы JPA, корректно обрабатываются отсутствующие сущности, исключены скрытые ошибки при работе с базой данных.

**ВИДЕО ОТЧЁТ ПО ИТЕРАЦИИ 1:** https://drive.google.com/file/d/1mL-2-CpcVp6bHTa52Y2Dqof5RRgVN8tz/view?usp=sharing

---

## ИТЕРАЦИЯ 2: Улучшение архитектуры и устранение дублирования

### Задача 2.1: Создание GlobalExceptionHandler

**Цель изменения:** Создать централизованный обработчик исключений для единообразной обработки всех ошибок в приложении и улучшения наблюдаемости через логирование.

**Измененные файлы:**
- Создан `ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/exception/GlobalExceptionHandler.java` (новый класс)

**Описание изменений:**

1. **GlobalExceptionHandler.java (новый класс):**
   - Создан класс с аннотацией `@ControllerAdvice` для глобальной обработки исключений
   - Добавлен метод `handleResponseStatusException()` для обработки `ResponseStatusException`:
     - Определяет HTTP статус из исключения
     - Логирует ошибку с уровнем ERROR
     - Возвращает соответствующую страницу ошибки (404 или 500)
     - Передает сообщение об ошибке в модель
   - Добавлен метод `handleIOException()` для обработки ошибок работы с файлами:
     - Логирует ошибку с уровнем ERROR
     - Возвращает страницу 500 с информативным сообщением
   - Добавлен метод `handleException()` как fallback для всех остальных исключений:
     - Логирует неожиданные исключения с уровнем ERROR
     - Возвращает страницу 500 с общим сообщением об ошибке
   - Использован SLF4J Logger для структурированного логирования

**Цель изменений:**
- **Централизация обработки ошибок:** Все исключения обрабатываются в одном месте, что упрощает поддержку и изменение логики обработки ошибок
- **Единообразие:** Все ошибки обрабатываются одинаково, пользователи получают консистентный опыт
- **Наблюдаемость:** Все исключения логируются, что упрощает отладку и мониторинг приложения
- **Улучшение пользовательского опыта:** Пользователи получают понятные сообщения об ошибках вместо технических деталей

**Diff:**

```diff
--- /dev/null
+++ b/ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/exception/GlobalExceptionHandler.java
@@ -0,0 +1,66 @@
+package com.gmail.v.c.charkin.gurmanfood.exception;
+
+import com.gmail.v.c.charkin.gurmanfood.constants.Pages;
+import org.slf4j.Logger;
+import org.slf4j.LoggerFactory;
+import org.springframework.http.HttpStatus;
+import org.springframework.ui.Model;
+import org.springframework.web.bind.annotation.ControllerAdvice;
+import org.springframework.web.bind.annotation.ExceptionHandler;
+import org.springframework.web.server.ResponseStatusException;
+
+import java.io.IOException;
+
+/**
+ * Глобальный обработчик исключений для всего приложения.
+ * Обеспечивает централизованную обработку всех исключений и единообразный формат ответов.
+ */
+@ControllerAdvice
+public class GlobalExceptionHandler {
+
+    private static final Logger logger = LoggerFactory.getLogger(GlobalExceptionHandler.class);
+
+    /**
+     * Обрабатывает ResponseStatusException - исключения с HTTP статусами.
+     *
+     * @param ex исключение
+     * @param model модель для передачи данных в представление
+     * @return имя представления для отображения ошибки
+     */
+    @ExceptionHandler(ResponseStatusException.class)
+    public String handleResponseStatusException(ResponseStatusException ex, Model model) {
+        logger.error("ResponseStatusException occurred: {}", ex.getMessage(), ex);
+        
+        HttpStatus status = ex.getStatus();
+        String errorMessage = ex.getReason() != null ? ex.getReason() : ex.getMessage();
+        
+        model.addAttribute("errorMessage", errorMessage);
+        
+        if (status == HttpStatus.NOT_FOUND) {
+            return Pages.ERROR_404;
+        }
+        
+        return Pages.ERROR_500;
+    }
+
+    /**
+     * Обрабатывает IOException - ошибки работы с файлами.
+     *
+     * @param ex исключение
+     * @param model модель для передачи данных в представление
+     * @return имя представления для отображения ошибки
+     */
+    @ExceptionHandler(IOException.class)
+    public String handleIOException(IOException ex, Model model) {
+        logger.error("IOException occurred: {}", ex.getMessage(), ex);
+        model.addAttribute("errorMessage", "File operation error: " + ex.getMessage());
+        return Pages.ERROR_500;
+    }
+
+    /**
+     * Обрабатывает все остальные исключения (fallback).
+     *
+     * @param ex исключение
+     * @param model модель для передачи данных в представление
+     * @return имя представления для отображения ошибки
+     */
+    @ExceptionHandler(Exception.class)
+    public String handleException(Exception ex, Model model) {
+        logger.error("Unexpected exception occurred: {}", ex.getMessage(), ex);
+        model.addAttribute("errorMessage", "An unexpected error occurred. Please try again later.");
+        return Pages.ERROR_500;
+    }
+}
```

**Результат:** Создан централизованный обработчик исключений. Все исключения теперь обрабатываются единообразно, логируются для отладки и мониторинга, пользователи получают понятные сообщения об ошибках.

---

### Задача 2.2: Внедрение кастомных исключений

**Цель изменения:** Создать иерархию кастомных исключений для более явной и понятной обработки ошибок, заменяя использование `ResponseStatusException` на специализированные исключения.

**Измененные файлы:**
- Создан `ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/exception/BusinessLogicException.java` (новый класс)
- Создан `ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/exception/EntityNotFoundException.java` (новый класс)
- Создан `ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/exception/ValidationException.java` (новый класс)
- Создан `ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/exception/FileUploadException.java` (новый класс)
- `ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/exception/GlobalExceptionHandler.java`
- `ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/impl/CartServiceImpl.java`
- `ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/impl/ShawarmaServiceImpl.java`
- `ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/impl/OrderServiceImpl.java`
- `ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/impl/AdminServiceImpl.java`
- `ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/impl/AuthenticationServiceImpl.java`

**Описание изменений:**

1. **Создана иерархия кастомных исключений:**
   - **BusinessLogicException** - базовое исключение для бизнес-логических ошибок (extends RuntimeException)
   - **EntityNotFoundException** - исключение для случаев, когда сущность не найдена (extends BusinessLogicException, автоматически преобразуется в HTTP 404)
   - **ValidationException** - исключение для ошибок валидации данных (extends BusinessLogicException)
   - **FileUploadException** - исключение для ошибок загрузки файлов (extends IOException)

2. **Обновлен GlobalExceptionHandler:**
   - Добавлен метод `handleEntityNotFoundException()` - обрабатывает EntityNotFoundException, возвращает страницу 404
   - Добавлен метод `handleFileUploadException()` - обрабатывает FileUploadException, возвращает страницу 500
   - Добавлен метод `handleValidationException()` - обрабатывает ValidationException, возвращает страницу 500
   - Добавлен метод `handleBusinessLogicException()` - обрабатывает общие бизнес-логические ошибки, возвращает страницу 500
   - Обработчики упорядочены по специфичности (от более специфичных к общим)

3. **Заменены ResponseStatusException на EntityNotFoundException в сервисах:**
   - **CartServiceImpl:** заменены 2 использования ResponseStatusException для SHAWARMA_NOT_FOUND
   - **ShawarmaServiceImpl:** заменено использование ResponseStatusException для SHAWARMA_NOT_FOUND
   - **OrderServiceImpl:** заменено использование ResponseStatusException для ORDER_NOT_FOUND
   - **AdminServiceImpl:** заменены 3 использования ResponseStatusException для ORDER_NOT_FOUND, SHAWARMA_NOT_FOUND, USER_NOT_FOUND
   - **AuthenticationServiceImpl:** заменено использование ResponseStatusException для INVALID_PASSWORD_CODE
   - Удалены импорты `org.springframework.http.HttpStatus` и `org.springframework.web.server.ResponseStatusException`
   - Добавлены импорты `com.gmail.v.c.charkin.gurmanfood.exception.EntityNotFoundException`

**Цель изменений:**
- **Семантическая ясность:** Кастомные исключения явно показывают тип ошибки (сущность не найдена, ошибка валидации, ошибка загрузки файла), что делает код более читаемым и понятным
- **Типобезопасность:** Использование специализированных исключений позволяет компилятору и IDE лучше отслеживать обработку ошибок
- **Расширяемость:** Иерархия исключений позволяет легко добавлять новые типы ошибок и их обработку
- **Разделение ответственности:** Разные типы исключений обрабатываются по-разному, что позволяет более точно контролировать поведение приложения
- **Улучшение тестируемости:** Кастомные исключения легче тестировать и мокировать

**Diff:**

```diff
--- /dev/null
+++ b/ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/exception/BusinessLogicException.java
@@ -0,0 +1,15 @@
+package com.gmail.v.c.charkin.gurmanfood.exception;
+
+/**
+ * Базовое исключение для бизнес-логических ошибок приложения.
+ * Используется для обработки ошибок, связанных с бизнес-правилами.
+ */
+public class BusinessLogicException extends RuntimeException {
+
+    public BusinessLogicException(String message) {
+        super(message);
+    }
+
+    public BusinessLogicException(String message, Throwable cause) {
+        super(message, cause);
+    }
+}
```

```diff
--- /dev/null
+++ b/ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/exception/EntityNotFoundException.java
@@ -0,0 +1,29 @@
+package com.gmail.v.c.charkin.gurmanfood.exception;
+
+import org.springframework.http.HttpStatus;
+import org.springframework.web.server.ResponseStatusException;
+
+/**
+ * Исключение, выбрасываемое когда запрашиваемая сущность не найдена в базе данных.
+ * Автоматически преобразуется в HTTP 404 статус.
+ */
+public class EntityNotFoundException extends BusinessLogicException {
+
+    private final HttpStatus status;
+
+    public EntityNotFoundException(String message) {
+        super(message);
+        this.status = HttpStatus.NOT_FOUND;
+    }
+
+    /**
+     * Преобразует исключение в ResponseStatusException для совместимости с существующим кодом.
+     *
+     * @return ResponseStatusException с HTTP 404 статусом
+     */
+    public ResponseStatusException toResponseStatusException() {
+        return new ResponseStatusException(status, getMessage());
+    }
+
+    public HttpStatus getStatus() {
+        return status;
+    }
+}
```

```diff
--- /dev/null
+++ b/ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/exception/ValidationException.java
@@ -0,0 +1,17 @@
+package com.gmail.v.c.charkin.gurmanfood.exception;
+
+/**
+ * Исключение, выбрасываемое при ошибках валидации данных.
+ * Используется для обработки ошибок валидации входных данных.
+ */
+public class ValidationException extends BusinessLogicException {
+
+    public ValidationException(String message) {
+        super(message);
+    }
+
+    public ValidationException(String message, Throwable cause) {
+        super(message, cause);
+    }
+}
```

```diff
--- /dev/null
+++ b/ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/exception/FileUploadException.java
@@ -0,0 +1,17 @@
+package com.gmail.v.c.charkin.gurmanfood.exception;
+
+import java.io.IOException;
+
+/**
+ * Исключение, выбрасываемое при ошибках загрузки или обработки файлов.
+ * Расширяет IOException для совместимости с существующим кодом.
+ */
+public class FileUploadException extends IOException {
+
+    public FileUploadException(String message) {
+        super(message);
+    }
+
+    public FileUploadException(String message, Throwable cause) {
+        super(message, cause);
+    }
+}
```

```diff
--- a/ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/exception/GlobalExceptionHandler.java
+++ b/ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/exception/GlobalExceptionHandler.java
@@ -23,6 +23,50 @@
     private static final Logger logger = LoggerFactory.getLogger(GlobalExceptionHandler.class);
 
     /**
+     * Обрабатывает EntityNotFoundException - когда сущность не найдена.
+     *
+     * @param ex исключение
+     * @param model модель для передачи данных в представление
+     * @return имя представления для отображения ошибки
+     */
+    @ExceptionHandler(EntityNotFoundException.class)
+    public String handleEntityNotFoundException(EntityNotFoundException ex, Model model) {
+        logger.error("EntityNotFoundException occurred: {}", ex.getMessage(), ex);
+        model.addAttribute("errorMessage", ex.getMessage());
+        return Pages.ERROR_404;
+    }
+
+    /**
+     * Обрабатывает FileUploadException - ошибки загрузки файлов.
+     *
+     * @param ex исключение
+     * @param model модель для передачи данных в представление
+     * @return имя представления для отображения ошибки
+     */
+    @ExceptionHandler(FileUploadException.class)
+    public String handleFileUploadException(FileUploadException ex, Model model) {
+        logger.error("FileUploadException occurred: {}", ex.getMessage(), ex);
+        model.addAttribute("errorMessage", "File upload error: " + ex.getMessage());
+        return Pages.ERROR_500;
+    }
+
+    /**
+     * Обрабатывает ValidationException - ошибки валидации данных.
+     *
+     * @param ex исключение
+     * @param model модель для передачи данных в представление
+     * @return имя представления для отображения ошибки
+     */
+    @ExceptionHandler(ValidationException.class)
+    public String handleValidationException(ValidationException ex, Model model) {
+        logger.warn("ValidationException occurred: {}", ex.getMessage(), ex);
+        model.addAttribute("errorMessage", "Validation error: " + ex.getMessage());
+        return Pages.ERROR_500;
+    }
+
+    /**
+     * Обрабатывает BusinessLogicException - общие бизнес-логические ошибки.
+     *
+     * @param ex исключение
+     * @param model модель для передачи данных в представление
+     * @return имя представления для отображения ошибки
+     */
+    @ExceptionHandler(BusinessLogicException.class)
+    public String handleBusinessLogicException(BusinessLogicException ex, Model model) {
+        logger.error("BusinessLogicException occurred: {}", ex.getMessage(), ex);
+        model.addAttribute("errorMessage", ex.getMessage());
+        return Pages.ERROR_500;
+    }
+
+    /**
      * Обрабатывает ResponseStatusException - исключения с HTTP статусами.
      * Оставлен для обратной совместимости с существующим кодом.
      *
@@ -45,6 +89,8 @@
 
     /**
      * Обрабатывает IOException - ошибки работы с файлами.
+     * Обрабатывает только IOException, которые не являются FileUploadException.
      *
      * @param ex исключение
      * @param model модель для передачи данных в представление
```

Пример замены в сервисах (на примере CartServiceImpl):
```diff
--- a/ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/impl/CartServiceImpl.java
+++ b/ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/impl/CartServiceImpl.java
@@ -3,13 +3,12 @@
 import com.gmail.v.c.charkin.gurmanfood.constants.ErrorMessage;
 import com.gmail.v.c.charkin.gurmanfood.domain.Shawarma;
 import com.gmail.v.c.charkin.gurmanfood.domain.User;
+import com.gmail.v.c.charkin.gurmanfood.exception.EntityNotFoundException;
 import com.gmail.v.c.charkin.gurmanfood.repository.ShawarmaRepository;
 import com.gmail.v.c.charkin.gurmanfood.service.CartService;
 import com.gmail.v.c.charkin.gurmanfood.service.UserService;
 import lombok.RequiredArgsConstructor;
-import org.springframework.http.HttpStatus;
 import org.springframework.stereotype.Service;
 import org.springframework.transaction.annotation.Transactional;
-import org.springframework.web.server.ResponseStatusException;
 
 import java.util.List;
@@ -33,7 +32,7 @@
     public void addShawarmaToCart(Long shawarmaId) {
         User user = userService.getAuthenticatedUser();
         Shawarma shawarma = shawarmaRepository.findById(shawarmaId)
-                .orElseThrow(() -> new ResponseStatusException(HttpStatus.NOT_FOUND, ErrorMessage.SHAWARMA_NOT_FOUND));
+                .orElseThrow(() -> new EntityNotFoundException(ErrorMessage.SHAWARMA_NOT_FOUND));
         user.getShawarmaList().add(shawarma);
     }
 
@@ -42,7 +41,7 @@
     public void removeShawarmaFromCart(Long shawarmaId) {
         User user = userService.getAuthenticatedUser();
         Shawarma shawarma = shawarmaRepository.findById(shawarmaId)
-                .orElseThrow(() -> new ResponseStatusException(HttpStatus.NOT_FOUND, ErrorMessage.SHAWARMA_NOT_FOUND));
+                .orElseThrow(() -> new EntityNotFoundException(ErrorMessage.SHAWARMA_NOT_FOUND));
         user.getShawarmaList().remove(shawarma);
     }
 }
```

**Результат:** Создана иерархия кастомных исключений. Все случаи "сущность не найдена" теперь используют `EntityNotFoundException` вместо `ResponseStatusException`, что делает код более семантически понятным и типобезопасным. Глобальный обработчик исключений обрабатывает все типы кастомных исключений с соответствующими HTTP статусами и логированием.

---

### Задача 2.3: Устранение дублирования логики валидации паролей

**Цель изменения:** Вынести дублирующуюся логику валидации паролей в отдельный сервис для устранения дублирования кода и обеспечения единообразия проверок.

**Измененные файлы:**
- Создан `ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/PasswordValidationService.java` (новый интерфейс)
- Создан `ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/impl/PasswordValidationServiceImpl.java` (новая реализация)
- `ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/impl/RegistrationServiceImpl.java`
- `ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/impl/UserServiceImpl.java`
- `ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/impl/AuthenticationServiceImpl.java`

**Описание изменений:**

1. **Создан PasswordValidationService (интерфейс):**
   - Определен метод `validatePasswordMatch(String password, String password2)` - проверяет совпадение пароля и его подтверждения
   - Метод возвращает `MessageResponse` с ошибкой, если пароли не совпадают, или `null`, если валидация прошла успешно
   - Добавлена JavaDoc документация

2. **Создан PasswordValidationServiceImpl (реализация):**
   - Реализована логика проверки совпадения паролей
   - Если пароли не совпадают, возвращается `MessageResponse` с типом "passwordError" и сообщением `ErrorMessage.PASSWORDS_DO_NOT_MATCH`
   - Если пароли совпадают, возвращается `null`

3. **Обновлены сервисы для использования PasswordValidationService:**
   - **RegistrationServiceImpl:**
     - Добавлена инжекция `PasswordValidationService`
     - Заменена дублирующаяся проверка `if (userRequest.getPassword() != null && !userRequest.getPassword().equals(userRequest.getPassword2()))` на вызов `passwordValidationService.validatePasswordMatch()`
   - **UserServiceImpl:**
     - Добавлена инжекция `PasswordValidationService`
     - Заменена дублирующаяся проверка `if (request.getPassword() != null && !request.getPassword().equals(request.getPassword2()))` на вызов `passwordValidationService.validatePasswordMatch()`
     - Удален неиспользуемый импорт `ErrorMessage`
   - **AuthenticationServiceImpl:**
     - Добавлена инжекция `PasswordValidationService`
     - Заменена дублирующаяся проверка `if (request.getPassword() != null && !request.getPassword().equals(request.getPassword2()))` на вызов `passwordValidationService.validatePasswordMatch()`

**Цель изменений:**
- **Устранение дублирования кода (DRY принцип):** Логика валидации паролей теперь находится в одном месте, что упрощает поддержку и изменение правил валидации
- **Единообразие:** Все места, где проверяются пароли, используют одинаковую логику, что гарантирует консистентное поведение
- **Переиспользование:** Сервис валидации паролей может быть легко использован в других частях приложения
- **Тестируемость:** Логику валидации паролей можно тестировать изолированно от бизнес-логики
- **Расширяемость:** В будущем можно легко добавить дополнительные правила валидации (например, проверку сложности пароля) в одном месте

**Diff:**

```diff
--- /dev/null
+++ b/ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/PasswordValidationService.java
@@ -0,0 +1,15 @@
+package com.gmail.v.c.charkin.gurmanfood.service;
+
+import com.gmail.v.c.charkin.gurmanfood.dto.response.MessageResponse;
+
+/**
+ * Сервис для валидации паролей.
+ * Предоставляет централизованную логику проверки паролей.
+ */
+public interface PasswordValidationService {
+
+    /**
+     * Проверяет совпадение пароля и его подтверждения.
+     *
+     * @param password пароль
+     * @param password2 подтверждение пароля
+     * @return MessageResponse с ошибкой, если пароли не совпадают, или null, если валидация прошла успешно
+     */
+    MessageResponse validatePasswordMatch(String password, String password2);
+}
```

```diff
--- /dev/null
+++ b/ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/impl/PasswordValidationServiceImpl.java
@@ -0,0 +1,20 @@
+package com.gmail.v.c.charkin.gurmanfood.service.impl;
+
+import com.gmail.v.c.charkin.gurmanfood.constants.ErrorMessage;
+import com.gmail.v.c.charkin.gurmanfood.dto.response.MessageResponse;
+import com.gmail.v.c.charkin.gurmanfood.service.PasswordValidationService;
+import org.springframework.stereotype.Service;
+
+/**
+ * Реализация сервиса валидации паролей.
+ */
+@Service
+public class PasswordValidationServiceImpl implements PasswordValidationService {
+
+    @Override
+    public MessageResponse validatePasswordMatch(String password, String password2) {
+        if (password != null && !password.equals(password2)) {
+            return new MessageResponse("passwordError", ErrorMessage.PASSWORDS_DO_NOT_MATCH);
+        }
+        return null;
+    }
+}
```

Пример замены в сервисах (на примере RegistrationServiceImpl):
```diff
--- a/ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/impl/RegistrationServiceImpl.java
+++ b/ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/impl/RegistrationServiceImpl.java
@@ -11,6 +11,7 @@
 import com.gmail.v.c.charkin.gurmanfood.repository.UserRepository;
 import com.gmail.v.c.charkin.gurmanfood.service.RegistrationService;
+import com.gmail.v.c.charkin.gurmanfood.service.PasswordValidationService;
 import lombok.RequiredArgsConstructor;
@@ -29,6 +30,7 @@
     private final PasswordEncoder passwordEncoder;
     private final RestTemplate restTemplate;
     private final ModelMapper modelMapper;
+    private final PasswordValidationService passwordValidationService;
 
     @Value("${recaptcha.url}")
     private String captchaUrl;
@@ -42,7 +44,10 @@
     @Override
     @Transactional
     public MessageResponse registration(String captchaResponse, UserRequest userRequest) {
-        if (userRequest.getPassword() != null && !userRequest.getPassword().equals(userRequest.getPassword2())) {
-            return new MessageResponse("passwordError", ErrorMessage.PASSWORDS_DO_NOT_MATCH);
+        MessageResponse passwordValidation = passwordValidationService.validatePasswordMatch(
+                userRequest.getPassword(), userRequest.getPassword2());
+        if (passwordValidation != null) {
+            return passwordValidation;
         }
```

Пример замены в UserServiceImpl:
```diff
--- a/ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/impl/UserServiceImpl.java
+++ b/ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/impl/UserServiceImpl.java
@@ -3,7 +3,6 @@
-import com.gmail.v.c.charkin.gurmanfood.constants.ErrorMessage;
 import com.gmail.v.c.charkin.gurmanfood.constants.SuccessMessage;
@@ -13,6 +12,7 @@
 import com.gmail.v.c.charkin.gurmanfood.repository.UserRepository;
 import com.gmail.v.c.charkin.gurmanfood.security.UserPrincipal;
 import com.gmail.v.c.charkin.gurmanfood.service.PasswordValidationService;
 import com.gmail.v.c.charkin.gurmanfood.service.UserService;
@@ -27,6 +27,7 @@
     private final UserRepository userRepository;
     private final OrderRepository orderRepository;
     private final PasswordEncoder passwordEncoder;
+    private final PasswordValidationService passwordValidationService;
 
     @Override
     public User getAuthenticatedUser() {
@@ -57,7 +58,10 @@
     @Override
     @Transactional
     public MessageResponse changePassword(ChangePasswordRequest request) {
-        if (request.getPassword() != null && !request.getPassword().equals(request.getPassword2())) {
-            return new MessageResponse("passwordError", ErrorMessage.PASSWORDS_DO_NOT_MATCH);
+        MessageResponse passwordValidation = passwordValidationService.validatePasswordMatch(
+                request.getPassword(), request.getPassword2());
+        if (passwordValidation != null) {
+            return passwordValidation;
         }
```

Пример замены в AuthenticationServiceImpl:
```diff
--- a/ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/impl/AuthenticationServiceImpl.java
+++ b/ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/impl/AuthenticationServiceImpl.java
@@ -9,6 +9,7 @@
 import com.gmail.v.c.charkin.gurmanfood.repository.UserRepository;
 import com.gmail.v.c.charkin.gurmanfood.service.AuthenticationService;
+import com.gmail.v.c.charkin.gurmanfood.service.PasswordValidationService;
 import lombok.RequiredArgsConstructor;
@@ -24,6 +25,7 @@
     private final UserRepository userRepository;
     private final PasswordEncoder passwordEncoder;
     private final MailService mailService;
+    private final PasswordValidationService passwordValidationService;
 
     @Override
     @Transactional
@@ -49,7 +51,10 @@
     @Override
     @Transactional
     public MessageResponse resetPassword(PasswordResetRequest request) {
-        if (request.getPassword() != null && !request.getPassword().equals(request.getPassword2())) {
-            return new MessageResponse("passwordError", ErrorMessage.PASSWORDS_DO_NOT_MATCH);
+        MessageResponse passwordValidation = passwordValidationService.validatePasswordMatch(
+                request.getPassword(), request.getPassword2());
+        if (passwordValidation != null) {
+            return passwordValidation;
         }
```

**Результат:** Логика валидации паролей вынесена в отдельный сервис `PasswordValidationService`. Дублирование кода устранено - все три места (регистрация, смена пароля, сброс пароля) теперь используют единый сервис для проверки совпадения паролей. Это упрощает поддержку и позволяет легко расширять правила валидации в будущем.

---

### Задача 2.4: Создание централизованного DTO маппера

**Цель изменения:** Создать централизованный сервис для маппинга DTO в сущности, чтобы инкапсулировать логику преобразования и упростить поддержку кода.

**Измененные файлы:**
- Создан `ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/DtoMapper.java` (новый интерфейс)
- Создан `ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/impl/DtoMapperImpl.java` (новая реализация)
- `ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/impl/RegistrationServiceImpl.java`
- `ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/impl/AdminServiceImpl.java`
- `ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/impl/OrderServiceImpl.java`
- `ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/impl/ShawarmaServiceImpl.java`

**Описание изменений:**

1. **Создан DtoMapper (интерфейс):**
   - Определены методы для маппинга DTO в сущности:
     - `mapToUser(UserRequest userRequest)` - маппинг UserRequest в User
     - `mapToShawarma(ShawarmaRequest shawarmaRequest)` - маппинг ShawarmaRequest в Shawarma
     - `mapToOrder(OrderRequest orderRequest)` - маппинг OrderRequest в Order
   - Добавлена JavaDoc документация для всех методов

2. **Создан DtoMapperImpl (реализация):**
   - Реализация использует ModelMapper для автоматического маппинга полей
   - Все методы делегируют вызовы ModelMapper
   - Инжектируется ModelMapper через конструктор (Lombok @RequiredArgsConstructor)

3. **Обновлены сервисы для использования DtoMapper:**
   - **RegistrationServiceImpl:**
     - Заменен `ModelMapper` на `DtoMapper`
     - Заменен вызов `modelMapper.map(userRequest, User.class)` на `dtoMapper.mapToUser(userRequest)`
   - **AdminServiceImpl:**
     - Заменен `ModelMapper` на `DtoMapper`
     - Заменен вызов `modelMapper.map(shawarmaRequest, Shawarma.class)` на `dtoMapper.mapToShawarma(shawarmaRequest)`
   - **OrderServiceImpl:**
     - Заменен `ModelMapper` на `DtoMapper`
     - Заменен вызов `modelMapper.map(orderRequest, Order.class)` на `dtoMapper.mapToOrder(orderRequest)`
   - **ShawarmaServiceImpl:**
     - Удален неиспользуемый `ModelMapper` (был объявлен, но не использовался)

**Цель изменений:**
- **Инкапсуляция логики маппинга:** Вся логика преобразования DTO в сущности находится в одном месте, что упрощает поддержку и изменение правил маппинга
- **Разделение ответственности:** Бизнес-сервисы больше не зависят напрямую от ModelMapper, что делает их более независимыми
- **Расширяемость:** В будущем можно легко добавить кастомные правила маппинга (например, маппинг вложенных объектов) в одном месте
- **Тестируемость:** Логику маппинга можно тестировать изолированно от бизнес-логики
- **Единообразие:** Все места, где происходит маппинг, используют единый интерфейс, что гарантирует консистентное поведение

**Diff:**

```diff
--- /dev/null
+++ b/ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/DtoMapper.java
@@ -0,0 +1,32 @@
+package com.gmail.v.c.charkin.gurmanfood.service;
+
+import com.gmail.v.c.charkin.gurmanfood.domain.Order;
+import com.gmail.v.c.charkin.gurmanfood.domain.Shawarma;
+import com.gmail.v.c.charkin.gurmanfood.domain.User;
+import com.gmail.v.c.charkin.gurmanfood.dto.request.OrderRequest;
+import com.gmail.v.c.charkin.gurmanfood.dto.request.ShawarmaRequest;
+import com.gmail.v.c.charkin.gurmanfood.dto.request.UserRequest;
+
+/**
+ * Сервис для маппинга DTO в сущности и обратно.
+ * Централизует всю логику преобразования между слоями представления и домена.
+ */
+public interface DtoMapper {
+
+    /**
+     * Маппит UserRequest в User.
+     *
+     * @param userRequest DTO запроса пользователя
+     * @return сущность User
+     */
+    User mapToUser(UserRequest userRequest);
+
+    /**
+     * Маппит ShawarmaRequest в Shawarma.
+     *
+     * @param shawarmaRequest DTO запроса шаурмы
+     * @return сущность Shawarma
+     */
+    Shawarma mapToShawarma(ShawarmaRequest shawarmaRequest);
+
+    /**
+     * Маппит OrderRequest в Order.
+     *
+     * @param orderRequest DTO запроса заказа
+     * @return сущность Order
+     */
+    Order mapToOrder(OrderRequest orderRequest);
+}
```

```diff
--- /dev/null
+++ b/ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/impl/DtoMapperImpl.java
@@ -0,0 +1,37 @@
+package com.gmail.v.c.charkin.gurmanfood.service.impl;
+
+import com.gmail.v.c.charkin.gurmanfood.domain.Order;
+import com.gmail.v.c.charkin.gurmanfood.domain.Shawarma;
+import com.gmail.v.c.charkin.gurmanfood.domain.User;
+import com.gmail.v.c.charkin.gurmanfood.dto.request.OrderRequest;
+import com.gmail.v.c.charkin.gurmanfood.dto.request.ShawarmaRequest;
+import com.gmail.v.c.charkin.gurmanfood.dto.request.UserRequest;
+import com.gmail.v.c.charkin.gurmanfood.service.DtoMapper;
+import lombok.RequiredArgsConstructor;
+import org.modelmapper.ModelMapper;
+import org.springframework.stereotype.Service;
+
+/**
+ * Реализация сервиса маппинга DTO.
+ * Использует ModelMapper для автоматического маппинга полей.
+ */
+@Service
+@RequiredArgsConstructor
+public class DtoMapperImpl implements DtoMapper {
+
+    private final ModelMapper modelMapper;
+
+    @Override
+    public User mapToUser(UserRequest userRequest) {
+        return modelMapper.map(userRequest, User.class);
+    }
+
+    @Override
+    public Shawarma mapToShawarma(ShawarmaRequest shawarmaRequest) {
+        return modelMapper.map(shawarmaRequest, Shawarma.class);
+    }
+
+    @Override
+    public Order mapToOrder(OrderRequest orderRequest) {
+        return modelMapper.map(orderRequest, Order.class);
+    }
+}
```

Пример замены в сервисах (на примере RegistrationServiceImpl):
```diff
--- a/ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/impl/RegistrationServiceImpl.java
+++ b/ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/impl/RegistrationServiceImpl.java
@@ -11,7 +11,7 @@
 import com.gmail.v.c.charkin.gurmanfood.repository.UserRepository;
 import com.gmail.v.c.charkin.gurmanfood.service.PasswordValidationService;
 import com.gmail.v.c.charkin.gurmanfood.service.RegistrationService;
+import com.gmail.v.c.charkin.gurmanfood.service.DtoMapper;
 import lombok.RequiredArgsConstructor;
-import org.modelmapper.ModelMapper;
@@ -32,7 +32,7 @@
     private final PasswordEncoder passwordEncoder;
     private final RestTemplate restTemplate;
-    private final ModelMapper modelMapper;
+    private final DtoMapper dtoMapper;
     private final PasswordValidationService passwordValidationService;
@@ -60,7 +60,7 @@
         if (!response.isSuccess()) {
             return new MessageResponse("captchaError", ErrorMessage.CAPTCHA_ERROR);
         }
-        User user = modelMapper.map(userRequest, User.class);
+        User user = dtoMapper.mapToUser(userRequest);
         user.setActive(false);
```

Пример замены в AdminServiceImpl:
```diff
--- a/ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/impl/AdminServiceImpl.java
+++ b/ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/impl/AdminServiceImpl.java
@@ -16,7 +16,7 @@
 import com.gmail.v.c.charkin.gurmanfood.repository.UserRepository;
 import com.gmail.v.c.charkin.gurmanfood.service.AdminService;
+import com.gmail.v.c.charkin.gurmanfood.service.DtoMapper;
 import com.gmail.v.c.charkin.gurmanfood.service.FileService;
 import lombok.RequiredArgsConstructor;
-import org.modelmapper.ModelMapper;
@@ -33,7 +33,7 @@
     private final ShawarmaRepository shawarmaRepository;
     private final OrderRepository orderRepository;
-    private final ModelMapper modelMapper;
+    private final DtoMapper dtoMapper;
     private final FileService fileService;
@@ -101,7 +101,7 @@
 
     private MessageResponse saveShawarma(ShawarmaRequest shawarmaRequest, MultipartFile file, String message) throws IOException {
-        Shawarma shawarma = modelMapper.map(shawarmaRequest, Shawarma.class);
+        Shawarma shawarma = dtoMapper.mapToShawarma(shawarmaRequest);
         if (file != null && !file.isEmpty()) {
```

Пример замены в OrderServiceImpl:
```diff
--- a/ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/impl/OrderServiceImpl.java
+++ b/ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/impl/OrderServiceImpl.java
@@ -10,7 +10,7 @@
 import com.gmail.v.c.charkin.gurmanfood.repository.OrderRepository;
 import com.gmail.v.c.charkin.gurmanfood.service.OrderService;
+import com.gmail.v.c.charkin.gurmanfood.service.DtoMapper;
 import com.gmail.v.c.charkin.gurmanfood.service.UserService;
 import lombok.RequiredArgsConstructor;
-import org.modelmapper.ModelMapper;
@@ -27,7 +27,7 @@
     private final UserService userService;
     private final OrderRepository orderRepository;
-    private final ModelMapper modelMapper;
+    private final DtoMapper dtoMapper;
     private final MailService mailService;
@@ -53,7 +53,7 @@
     @Transactional
     public Long postOrder(User user, OrderRequest orderRequest) {
-        Order order = modelMapper.map(orderRequest, Order.class);
+        Order order = dtoMapper.mapToOrder(orderRequest);
         order.setUser(user);
```

Пример удаления неиспользуемого ModelMapper из ShawarmaServiceImpl:
```diff
--- a/ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/impl/ShawarmaServiceImpl.java
+++ b/ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/impl/ShawarmaServiceImpl.java
@@ -8,7 +8,6 @@
 import com.gmail.v.c.charkin.gurmanfood.repository.ShawarmaRepository;
 import com.gmail.v.c.charkin.gurmanfood.service.ShawarmaService;
 import lombok.RequiredArgsConstructor;
-import org.modelmapper.ModelMapper;
 import org.springframework.data.domain.Page;
@@ -21,7 +20,6 @@
 public class ShawarmaServiceImpl implements ShawarmaService {
 
     private final ShawarmaRepository shawarmaRepository;
-    private final ModelMapper modelMapper;
```

**Результат:** Создан централизованный сервис `DtoMapper` для маппинга DTO в сущности. Все бизнес-сервисы теперь используют единый интерфейс для преобразования данных, что инкапсулирует логику маппинга и упрощает поддержку. Зависимость от ModelMapper удалена из бизнес-сервисов, что делает их более независимыми и тестируемыми.

---

### Задача 2.5: Рефакторинг MailService для правильного управления ExecutorService

**Цель изменения:** Исправить проблемы с управлением ExecutorService в MailService - создать пул потоков один раз и корректно завершать его при остановке приложения.

**Измененные файлы:**
- `ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/impl/MailService.java`

**Описание изменений:**

1. **Исправлено управление жизненным циклом ExecutorService:**
   - ExecutorService теперь создается один раз при инициализации бина через метод `init()` с аннотацией `@PostConstruct`
   - ExecutorService объявлен как поле класса вместо создания при каждом вызове метода
   - Добавлены константы `THREAD_POOL_SIZE = 10` и `SHUTDOWN_TIMEOUT_SECONDS = 30` для конфигурируемости

2. **Добавлено корректное завершение ExecutorService:**
   - Добавлен метод `destroy()` с аннотацией `@PreDestroy` для корректного завершения ExecutorService при остановке приложения
   - Реализована логика graceful shutdown:
     - Сначала вызывается `shutdown()` для остановки приема новых задач
     - Ожидается завершение выполнения задач в течение 30 секунд
     - Если задачи не завершились, вызывается `shutdownNow()` для принудительной остановки
     - Обрабатывается `InterruptedException` для корректной обработки прерываний

3. **Улучшена обработка ошибок и логирование:**
   - Добавлен SLF4J Logger через аннотацию `@Slf4j`
   - Добавлено логирование инициализации и завершения ExecutorService
   - Добавлено логирование успешной отправки email (уровень DEBUG)
   - Добавлено логирование ошибок отправки email (уровень ERROR)
   - Улучшена обработка исключений с информативными сообщениями

4. **Добавлена документация:**
   - Добавлен JavaDoc для класса
   - Добавлен JavaDoc для всех методов
   - Добавлены комментарии к константам

**Цель изменений:**
- **Производительность:** ExecutorService создается один раз и переиспользуется, что более эффективно, чем создание нового пула при каждом вызове
- **Надежность:** Корректное завершение ExecutorService гарантирует, что все задачи будут выполнены или корректно прерваны при остановке приложения
- **Предотвращение утечек ресурсов:** Правильное управление жизненным циклом ExecutorService предотвращает утечки потоков и ресурсов
- **Наблюдаемость:** Логирование позволяет отслеживать работу сервиса и диагностировать проблемы
- **Соответствие best practices:** Использование `@PostConstruct` и `@PreDestroy` - стандартный подход для управления жизненным циклом ресурсов в Spring

**Diff:**

```diff
--- a/ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/impl/MailService.java
+++ b/ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/impl/MailService.java
@@ -1,51 +1,95 @@
 package com.gmail.v.c.charkin.gurmanfood.service.impl;
 
 import lombok.RequiredArgsConstructor;
+import lombok.extern.slf4j.Slf4j;
 import org.springframework.beans.factory.annotation.Value;
 import org.springframework.mail.javamail.JavaMailSender;
 import org.springframework.mail.javamail.MimeMessageHelper;
 import org.springframework.stereotype.Service;
 import org.thymeleaf.context.Context;
 import org.thymeleaf.spring5.SpringTemplateEngine;
 
+import javax.annotation.PostConstruct;
+import javax.annotation.PreDestroy;
 import javax.mail.MessagingException;
 import javax.mail.internet.MimeMessage;
 import java.util.Map;
 import java.util.concurrent.ExecutorService;
 import java.util.concurrent.Executors;
+import java.util.concurrent.TimeUnit;
 
+/**
+ * Сервис для отправки email сообщений.
+ * Использует ExecutorService для асинхронной отправки писем.
+ */
+@Slf4j
 @Service
 @RequiredArgsConstructor
 public class MailService {
 
+    private static final int THREAD_POOL_SIZE = 10;
+    private static final long SHUTDOWN_TIMEOUT_SECONDS = 30;
+
     private final JavaMailSender mailSender;
     private final SpringTemplateEngine thymeleafTemplateEngine;
 
     @Value("${spring.mail.username}")
     private String username;
 
     @Value("${hostname}")
     private String hostname;
 
+    private ExecutorService executorService;
+
+    /**
+     * Инициализирует ExecutorService при создании бина.
+     */
+    @PostConstruct
+    public void init() {
+        executorService = Executors.newFixedThreadPool(THREAD_POOL_SIZE);
+        log.info("MailService initialized with thread pool size: {}", THREAD_POOL_SIZE);
+    }
+
+    /**
+     * Корректно завершает ExecutorService при остановке приложения.
+     */
+    @PreDestroy
+    public void destroy() {
+        if (executorService != null) {
+            log.info("Shutting down MailService ExecutorService...");
+            executorService.shutdown();
+            try {
+                if (!executorService.awaitTermination(SHUTDOWN_TIMEOUT_SECONDS, TimeUnit.SECONDS)) {
+                    log.warn("ExecutorService did not terminate in {} seconds, forcing shutdown", SHUTDOWN_TIMEOUT_SECONDS);
+                    executorService.shutdownNow();
+                    if (!executorService.awaitTermination(SHUTDOWN_TIMEOUT_SECONDS, TimeUnit.SECONDS)) {
+                        log.error("ExecutorService did not terminate after forced shutdown");
+                    }
+                }
+            } catch (InterruptedException e) {
+                log.error("Interrupted while waiting for ExecutorService termination", e);
+                executorService.shutdownNow();
+                Thread.currentThread().interrupt();
+            }
+            log.info("MailService ExecutorService shutdown completed");
+        }
+    }
+
+    /**
+     * Отправляет HTML email сообщение асинхронно.
+     *
+     * @param to адрес получателя
+     * @param subject тема письма
+     * @param template имя шаблона (без расширения)
+     * @param attributes атрибуты для шаблона
+     */
     public void sendMessageHtml(String to, String subject, String template, Map<String, Object> attributes) {
-        ExecutorService executor = Executors.newFixedThreadPool(10);
-        executor.execute(() -> {
-            attributes.put("url", "http://" + hostname);
-            Context thymeleafContext = new Context();
-            thymeleafContext.setVariables(attributes);
-            String htmlBody = thymeleafTemplateEngine.process("email/" + template, thymeleafContext);
-            MimeMessage message = mailSender.createMimeMessage();
-            try {
-                MimeMessageHelper helper = new MimeMessageHelper(message, true, "UTF-8");
-                helper.setFrom(username);
-                helper.setTo(to);
-                helper.setSubject(subject);
-                helper.setText(htmlBody, true);
-                mailSender.send(message);
-            } catch (MessagingException e) {
-                throw new RuntimeException(e);
+        executorService.execute(() -> {
+            try {
+                attributes.put("url", "http://" + hostname);
+                Context thymeleafContext = new Context();
+                thymeleafContext.setVariables(attributes);
+                String htmlBody = thymeleafTemplateEngine.process("email/" + template, thymeleafContext);
+                MimeMessage message = mailSender.createMimeMessage();
+                MimeMessageHelper helper = new MimeMessageHelper(message, true, "UTF-8");
+                helper.setFrom(username);
+                helper.setTo(to);
+                helper.setSubject(subject);
+                helper.setText(htmlBody, true);
+                mailSender.send(message);
+                log.debug("Email sent successfully to: {}", to);
+            } catch (MessagingException e) {
+                log.error("Failed to send email to: {}", to, e);
+                throw new RuntimeException("Failed to send email", e);
             }
         });
-        executor.shutdown();
     }
 }
```

**Результат:** Исправлено управление ExecutorService в MailService. Пул потоков теперь создается один раз при инициализации бина и корректно завершается при остановке приложения. Это предотвращает утечки ресурсов, улучшает производительность и обеспечивает надежное завершение всех задач при остановке приложения. Добавлено логирование для наблюдения за работой сервиса.

---

### Задача 2.6: Реструктуризация утилитных классов

**Цель изменения:** Разделить монолитный класс `ControllerUtils` на три специализированных утилитных класса для улучшения организации кода и соблюдения принципа единственной ответственности.

**Измененные файлы:**
- Создан `ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/utils/PaginationUtils.java` (новый класс)
- Создан `ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/utils/ValidationUtils.java` (новый класс)
- Создан `ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/utils/ModelUtils.java` (новый класс)
- Удален `ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/utils/ControllerUtils.java` (старый класс)
- `ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/controller/AdminController.java`
- `ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/controller/UserController.java`
- `ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/controller/ShawarmaController.java`
- `ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/controller/OrderController.java`
- `ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/controller/RegistrationController.java`
- `ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/controller/AuthenticationController.java`

**Описание изменений:**

1. **Создан PaginationUtils:**
   - Содержит методы для работы с пагинацией:
     - `addPagination(Model model, Page<T> page)` - добавляет информацию о пагинации в модель
     - `addPagination(SearchRequest searchRequest, Model model, Page<T> page)` - добавляет пагинацию и поисковый запрос
     - `computePagination(Page<?> page)` - вычисляет массив номеров страниц для отображения (приватный метод)
   - Добавлена константа `MAX_PAGES_WITHOUT_ELLIPSIS = 7` для конфигурируемости
   - Добавлена JavaDoc документация

2. **Создан ValidationUtils:**
   - Содержит методы для валидации данных:
     - `validateInputFields(BindingResult bindingResult, Model model, String attributeKey, Object attributeValue)` - проверяет результат валидации и добавляет ошибки в модель
     - `validateInputField(Model model, MessageResponse messageResponse, String attributeKey, Object attributeValue)` - проверяет результат операции и добавляет сообщение об ошибке
     - `getErrors(BindingResult bindingResult)` - преобразует ошибки валидации в Map (приватный метод)
   - Добавлена JavaDoc документация

3. **Создан ModelUtils:**
   - Содержит методы для работы с моделью представления:
     - `setAlertMessage(Model model, String page, MessageResponse messageResponse)` - устанавливает сообщение в модель
     - `setAlertFlashMessage(RedirectAttributes redirectAttributes, String page, MessageResponse messageResponse)` - устанавливает flash-сообщение для редиректа
   - Добавлена JavaDoc документация

4. **Обновлены все контроллеры:**
   - Заменены импорты `ControllerUtils` на соответствующие утилитные классы
   - Заменены инжекции `ControllerUtils` на инжекции специализированных утилит
   - Обновлены все вызовы методов для использования новых утилитных классов:
     - `controllerUtils.addPagination()` → `paginationUtils.addPagination()`
     - `controllerUtils.validateInputFields()` → `validationUtils.validateInputFields()`
     - `controllerUtils.validateInputField()` → `validationUtils.validateInputField()`
     - `controllerUtils.setAlertMessage()` → `modelUtils.setAlertMessage()`
     - `controllerUtils.setAlertFlashMessage()` → `modelUtils.setAlertFlashMessage()`

5. **Удален старый ControllerUtils:**
   - Класс удален, так как его функциональность полностью распределена по новым утилитным классам

**Цель изменений:**
- **Принцип единственной ответственности (Single Responsibility Principle):** Каждый утилитный класс отвечает только за свою область (пагинация, валидация, работа с моделью)
- **Улучшенная организация кода:** Код лучше организован, легче найти нужную функциональность
- **Упрощение поддержки:** Изменения в одной области (например, пагинация) не затрагивают другие области
- **Повышение читаемости:** Контроллеры используют специализированные утилиты, что делает код более понятным
- **Переиспользование:** Утилитные классы можно использовать независимо друг от друга

**Diff:**

```diff
--- /dev/null
+++ b/ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/utils/PaginationUtils.java
@@ -0,0 +1,67 @@
+package com.gmail.v.c.charkin.gurmanfood.utils;
+
+import com.gmail.v.c.charkin.gurmanfood.dto.request.SearchRequest;
+import org.springframework.data.domain.Page;
+import org.springframework.stereotype.Component;
+import org.springframework.ui.Model;
+
+import java.util.ArrayList;
+import java.util.Arrays;
+import java.util.Collections;
+import java.util.List;
+import java.util.stream.IntStream;
+
+/**
+ * Утилитный класс для работы с пагинацией.
+ * Предоставляет методы для вычисления и добавления информации о пагинации в модель.
+ */
+@Component
+public class PaginationUtils {
+
+    private static final int MAX_PAGES_WITHOUT_ELLIPSIS = 7;
+
+    /**
+     * Добавляет информацию о пагинации в модель.
+     *
+     * @param model модель для добавления атрибутов
+     * @param page страница с данными
+     * @param <T> тип элементов на странице
+     */
+    public <T> void addPagination(Model model, Page<T> page) {
+        model.addAttribute("pagination", computePagination(page));
+        model.addAttribute("page", page);
+    }
+
+    /**
+     * Добавляет информацию о пагинации и поисковом запросе в модель.
+     *
+     * @param searchRequest поисковый запрос
+     * @param model модель для добавления атрибутов
+     * @param page страница с данными
+     * @param <T> тип элементов на странице
+     */
+    public <T> void addPagination(SearchRequest searchRequest, Model model, Page<T> page) {
+        model.addAttribute("searchRequest", searchRequest);
+        addPagination(model, page);
+    }
+
+    /**
+     * Вычисляет массив номеров страниц для отображения пагинации.
+     * Использует эллипсис (-1) для больших списков страниц.
+     *
+     * @param page страница с данными
+     * @return массив номеров страниц для отображения
+     */
+    private int[] computePagination(Page<?> page) {
+        Integer totalPages = page.getTotalPages();
+        
+        if (totalPages <= MAX_PAGES_WITHOUT_ELLIPSIS) {
+            return IntStream.rangeClosed(1, totalPages).toArray();
+        }
+
+        Integer pageNumber = page.getNumber() + 1;
+        Integer[] head = pageNumber > 4 ? new Integer[]{1, -1} : new Integer[]{1, 2, 3};
+        Integer[] tail = pageNumber < (totalPages - 3) 
+                ? new Integer[]{-1, totalPages} 
+                : new Integer[]{totalPages - 2, totalPages - 1, totalPages};
+        Integer[] bodyBefore = (pageNumber > 4 && pageNumber < (totalPages - 1)) 
+                ? new Integer[]{pageNumber - 2, pageNumber - 1} 
+                : new Integer[]{};
+        Integer[] bodyAfter = (pageNumber > 2 && pageNumber < (totalPages - 3)) 
+                ? new Integer[]{pageNumber + 1, pageNumber + 2} 
+                : new Integer[]{};
+
+        List<Integer> list = new ArrayList<>();
+        Collections.addAll(list, head);
+        Collections.addAll(list, bodyBefore);
+        Collections.addAll(list, (pageNumber > 3 && pageNumber < totalPages - 2) 
+                ? new Integer[]{pageNumber} 
+                : new Integer[]{});
+        Collections.addAll(list, bodyAfter);
+        Collections.addAll(list, tail);
+        
+        Integer[] arr = list.toArray(new Integer[0]);
+        return Arrays.stream(arr).mapToInt(Integer::intValue).toArray();
+    }
+}
```

```diff
--- /dev/null
+++ b/ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/utils/ValidationUtils.java
@@ -0,0 +1,52 @@
+package com.gmail.v.c.charkin.gurmanfood.utils;
+
+import com.gmail.v.c.charkin.gurmanfood.dto.response.MessageResponse;
+import org.springframework.stereotype.Component;
+import org.springframework.ui.Model;
+import org.springframework.validation.BindingResult;
+import org.springframework.validation.FieldError;
+
+import java.util.Map;
+import java.util.stream.Collectors;
+
+/**
+ * Утилитный класс для валидации данных.
+ * Предоставляет методы для проверки и обработки ошибок валидации.
+ */
+@Component
+public class ValidationUtils {
+
+    /**
+     * Проверяет результат валидации и добавляет ошибки в модель.
+     *
+     * @param bindingResult результат валидации
+     * @param model модель для добавления ошибок
+     * @param attributeKey ключ атрибута для сохранения исходного значения
+     * @param attributeValue значение атрибута для сохранения
+     * @return true, если есть ошибки валидации, false в противном случае
+     */
+    public boolean validateInputFields(BindingResult bindingResult, Model model, String attributeKey, Object attributeValue) {
+        if (bindingResult.hasErrors()) {
+            model.mergeAttributes(getErrors(bindingResult));
+            model.addAttribute(attributeKey, attributeValue);
+            return true;
+        }
+        return false;
+    }
+
+    /**
+     * Проверяет результат операции и добавляет сообщение об ошибке в модель.
+     *
+     * @param model модель для добавления сообщения
+     * @param messageResponse ответ с результатом операции
+     * @param attributeKey ключ атрибута для сохранения исходного значения
+     * @param attributeValue значение атрибута для сохранения
+     * @return true, если операция не успешна, false в противном случае
+     */
+    public boolean validateInputField(Model model, MessageResponse messageResponse, String attributeKey, Object attributeValue) {
+        if (!messageResponse.getResponse().contains("success")) {
+            model.addAttribute(messageResponse.getResponse(), messageResponse.getMessage());
+            model.addAttribute(attributeKey, attributeValue);
+            return true;
+        }
+        return false;
+    }
+
+    /**
+     * Преобразует ошибки валидации в Map для добавления в модель.
+     *
+     * @param bindingResult результат валидации
+     * @return Map с ошибками, где ключ - имя поля с суффиксом "Error", значение - сообщение об ошибке
+     */
+    private Map<String, String> getErrors(BindingResult bindingResult) {
+        return bindingResult.getFieldErrors().stream()
+                .collect(Collectors.toMap(
+                        fieldError -> fieldError.getField() + "Error",
+                        FieldError::getDefaultMessage
+                ));
+    }
+}
```

```diff
--- /dev/null
+++ b/ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/utils/ModelUtils.java
@@ -0,0 +1,33 @@
+package com.gmail.v.c.charkin.gurmanfood.utils;
+
+import com.gmail.v.c.charkin.gurmanfood.dto.response.MessageResponse;
+import org.springframework.stereotype.Component;
+import org.springframework.ui.Model;
+import org.springframework.web.servlet.mvc.support.RedirectAttributes;
+
+/**
+ * Утилитный класс для работы с моделью представления.
+ * Предоставляет методы для добавления сообщений в модель и RedirectAttributes.
+ */
+@Component
+public class ModelUtils {
+
+    /**
+     * Устанавливает сообщение в модель и возвращает имя представления.
+     *
+     * @param model модель для добавления сообщения
+     * @param page имя представления
+     * @param messageResponse ответ с сообщением
+     * @return имя представления
+     */
+    public String setAlertMessage(Model model, String page, MessageResponse messageResponse) {
+        model.addAttribute("messageType", messageResponse.getResponse());
+        model.addAttribute("message", messageResponse.getMessage());
+        return page;
+    }
+
+    /**
+     * Устанавливает flash-сообщение в RedirectAttributes и возвращает редирект.
+     *
+     * @param redirectAttributes атрибуты для редиректа
+     * @param page путь для редиректа
+     * @param messageResponse ответ с сообщением
+     * @return строка редиректа
+     */
+    public String setAlertFlashMessage(RedirectAttributes redirectAttributes, String page, MessageResponse messageResponse) {
+        redirectAttributes.addFlashAttribute("messageType", messageResponse.getResponse());
+        redirectAttributes.addFlashAttribute("message", messageResponse.getMessage());
+        return "redirect:" + page;
+    }
+}
```

Пример замены в контроллерах (на примере AdminController):
```diff
--- a/ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/controller/AdminController.java
+++ b/ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/controller/AdminController.java
@@ -8,7 +8,9 @@
 import com.gmail.v.c.charkin.gurmanfood.dto.response.UserInfoResponse;
 import com.gmail.v.c.charkin.gurmanfood.service.AdminService;
-import com.gmail.v.c.charkin.gurmanfood.utils.ControllerUtils;
+import com.gmail.v.c.charkin.gurmanfood.utils.ModelUtils;
+import com.gmail.v.c.charkin.gurmanfood.utils.PaginationUtils;
+import com.gmail.v.c.charkin.gurmanfood.utils.ValidationUtils;
 import lombok.RequiredArgsConstructor;
@@ -29,7 +31,9 @@
 public class AdminController {
 
     private final AdminService adminService;
-    private final ControllerUtils controllerUtils;
+    private final PaginationUtils paginationUtils;
+    private final ValidationUtils validationUtils;
+    private final ModelUtils modelUtils;
 
     @GetMapping("/shawarmas")
     public String getShawarmas(Pageable pageable, Model model) {
-        controllerUtils.addPagination(model, adminService.getShawarmas(pageable));
+        paginationUtils.addPagination(model, adminService.getShawarmas(pageable));
         return Pages.ADMIN_SHAWARMAS;
     }
@@ -82,7 +86,7 @@
     public String editShawarma(@Valid ShawarmaRequest shawarma, BindingResult bindingResult, Model model,
                               @RequestParam("file") MultipartFile file, RedirectAttributes attributes) throws IOException {
-        if (controllerUtils.validateInputFields(bindingResult, model, "shawarma", shawarma)) {
+        if (validationUtils.validateInputFields(bindingResult, model, "shawarma", shawarma)) {
             return Pages.ADMIN_EDIT_SHAWARMA;
         }
-        return controllerUtils.setAlertFlashMessage(attributes, "/admin/shawarmas", adminService.editShawarma(shawarma, file));
+        return modelUtils.setAlertFlashMessage(attributes, "/admin/shawarmas", adminService.editShawarma(shawarma, file));
     }
```

**Результат:** Монолитный класс `ControllerUtils` разделен на три специализированных утилитных класса: `PaginationUtils`, `ValidationUtils` и `ModelUtils`. Все контроллеры обновлены для использования новых утилитных классов. Это улучшает организацию кода, соблюдает принцип единственной ответственности и упрощает поддержку. Старый `ControllerUtils` удален.

**ВИДЕООТЧЕТ ПО ИТОГАМ 2 ИТЕРАЦИИ:** https://drive.google.com/file/d/1UnbP5Y9C-6Zfj4TBjVy8S0OiEipj0ron/view?usp=sharing

---

## ИТЕРАЦИЯ 3: Оптимизация производительности и финальная подготовка

### Задача 3.1: Оптимизация запросов к БД

**Цель изменения:** Устранить проблемы N+1 запросов и оптимизировать загрузку связанных сущностей для улучшения производительности приложения.

**Измененные файлы:**
- `ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/repository/UserRepository.java`
- `ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/impl/UserServiceImpl.java`
- `ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/domain/User.java`
- `ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/domain/Order.java`
- Создан `ShawarmaShop/src/main/resources/db/migration/V5__Add_indexes.sql` (новая миграция)

**Описание изменений:**

1. **UserRepository.java:**
   - Добавлен новый метод `findByEmailWithCart(String email)` с аннотацией `@EntityGraph(attributePaths = {"roles", "shawarmaList"})`
   - Метод оптимизирует загрузку пользователя вместе с его ролями и корзиной (shawarmaList) в одном запросе, предотвращая N+1 проблему

2. **UserServiceImpl.java:**
   - Обновлен метод `getAuthenticatedUser()` для использования нового метода `findByEmailWithCart()` вместо `findByEmail()`
   - Это гарантирует, что при загрузке аутентифицированного пользователя его корзина загружается сразу, без дополнительных запросов

3. **User.java:**
   - Добавлен явный `fetch = FetchType.LAZY` для связи `@ManyToMany` с `shawarmaList`
   - Это делает стратегию загрузки явной и предотвращает нежелательную eager загрузку

4. **Order.java:**
   - Добавлен явный `fetch = FetchType.LAZY` для связи `@ManyToMany` с `shawarmas`
   - Это делает стратегию загрузки явной и предотвращает нежелательную eager загрузку

5. **V5__Add_indexes.sql (новая миграция):**
   - Создана миграция Flyway для добавления индексов:
     - `idx_users_email` на таблице `users(email)` - для оптимизации поиска пользователей по email
     - `idx_orders_user_id` на таблице `orders(user_id)` - для оптимизации поиска заказов по пользователю
     - `idx_shawarmas_category` на таблице `shawarmas(category)` - для оптимизации фильтрации по категории
   - Использован `CREATE INDEX IF NOT EXISTS` для безопасного выполнения миграции

**Цель изменений:**
- **Устранение N+1 проблем:** Использование `@EntityGraph` позволяет загружать связанные сущности в одном запросе, что значительно снижает количество запросов к БД
- **Повышение производительности:** Индексы ускоряют поиск по часто используемым полям (email, user_id, category)
- **Оптимизация использования памяти:** Явное указание `FetchType.LAZY` предотвращает нежелательную загрузку больших коллекций
- **Улучшение масштабируемости:** Оптимизированные запросы лучше работают при увеличении объема данных

**Diff:**

```diff
--- a/ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/repository/UserRepository.java
+++ b/ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/repository/UserRepository.java
@@ -32,4 +32,7 @@
             "LIKE UPPER(CONCAT('%',:text,'%'))")
     Page<User> searchUsers(String searchType, String text, Pageable pageable);
+
+    @EntityGraph(attributePaths = {"roles", "shawarmaList"})
+    User findByEmailWithCart(String email);
 }
```

```diff
--- a/ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/impl/UserServiceImpl.java
+++ b/ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/impl/UserServiceImpl.java
@@ -33,7 +33,7 @@
     @Override
     public User getAuthenticatedUser() {
         UserPrincipal principal = (UserPrincipal) SecurityContextHolder.getContext().getAuthentication().getPrincipal();
-        return userRepository.findByEmail(principal.getUsername());
+        return userRepository.findByEmailWithCart(principal.getUsername());
     }
```

```diff
--- a/ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/domain/User.java
+++ b/ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/domain/User.java
@@ -60,5 +60,5 @@
     private Set<Role> roles;
 
-    @ManyToMany
+    @ManyToMany(fetch = FetchType.LAZY)
     private List<Shawarma> shawarmaList;
 }
```

```diff
--- a/ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/domain/Order.java
+++ b/ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/domain/Order.java
@@ -44,5 +44,5 @@
     private String phoneNumber;
 
-    @ManyToMany
+    @ManyToMany(fetch = FetchType.LAZY)
     private List<Shawarma> shawarmas = new ArrayList<>();
```

```diff
--- /dev/null
+++ b/ShawarmaShop/src/main/resources/db/migration/V5__Add_indexes.sql
@@ -0,0 +1,8 @@
+-- Индексы для оптимизации запросов к базе данных
+
+-- Индекс для быстрого поиска пользователей по email
+CREATE INDEX IF NOT EXISTS idx_users_email ON users(email);
+
+-- Индекс для быстрого поиска заказов по пользователю
+CREATE INDEX IF NOT EXISTS idx_orders_user_id ON orders(user_id);
+
+-- Индекс для быстрого поиска шаурмы по категории
+CREATE INDEX IF NOT EXISTS idx_shawarmas_category ON shawarmas(category);
```

**Результат:** Оптимизированы запросы к БД: добавлен `@EntityGraph` для предотвращения N+1 проблем при загрузке пользователя с корзиной, явно указан `FetchType.LAZY` для всех `@ManyToMany` связей, созданы индексы для часто используемых полей. Это значительно улучшает производительность приложения, особенно при работе с большими объемами данных.

---

### Задача 3.2: Внедрение структурированного логирования (SLF4J)

**Цель изменения:** Добавить структурированное логирование во все ключевые сервисы для улучшения наблюдаемости, отладки и мониторинга приложения.

**Измененные файлы:**
- `ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/impl/AdminServiceImpl.java`
- `ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/impl/OrderServiceImpl.java`
- `ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/impl/RegistrationServiceImpl.java`
- `ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/impl/AuthenticationServiceImpl.java`
- `ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/impl/CartServiceImpl.java`
- `ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/impl/UserServiceImpl.java`

**Описание изменений:**

1. **AdminServiceImpl.java:**
   - Добавлена аннотация `@Slf4j` для автоматического создания logger
   - Добавлено логирование уровня INFO для операций добавления и редактирования шаурмы
   - Добавлено логирование уровня DEBUG для операций получения данных (заказы, шаурма, пользователи)
   - Добавлено логирование уровня WARN для случаев, когда сущности не найдены
   - Добавлено логирование уровня DEBUG для операций сохранения файлов

2. **OrderServiceImpl.java:**
   - Добавлена аннотация `@Slf4j`
   - Добавлено логирование уровня INFO для создания заказов с информацией о пользователе и общей стоимости
   - Добавлено логирование уровня DEBUG для получения заказов и отправки email-уведомлений
   - Добавлено логирование уровня WARN для случаев, когда заказ не найден
   - Добавлено логирование очистки корзины после создания заказа

3. **RegistrationServiceImpl.java:**
   - Добавлена аннотация `@Slf4j`
   - Добавлено логирование уровня INFO для успешной регистрации и активации пользователей
   - Добавлено логирование уровня WARN для ошибок регистрации (несовпадение паролей, email уже используется, ошибка captcha)
   - Добавлено логирование уровня WARN для невалидных кодов активации
   - Добавлено логирование уровня DEBUG для отправки email-уведомлений

4. **AuthenticationServiceImpl.java:**
   - Добавлена аннотация `@Slf4j`
   - Добавлено логирование уровня INFO для запросов сброса пароля и успешного сброса
   - Добавлено логирование уровня WARN для ошибок (email не найден, несовпадение паролей, невалидный код сброса)
   - Добавлено логирование уровня DEBUG для получения email по коду сброса и отправки email-уведомлений

5. **CartServiceImpl.java:**
   - Добавлена аннотация `@Slf4j`
   - Добавлено логирование уровня INFO для успешных операций добавления и удаления товаров из корзины
   - Добавлено логирование уровня DEBUG для начала операций с корзиной
   - Добавлено логирование уровня WARN для случаев, когда шаурма не найдена при попытке добавить/удалить из корзины

6. **UserServiceImpl.java:**
   - Добавлена аннотация `@Slf4j`
   - Добавлено логирование уровня INFO для операций обновления информации пользователя и смены пароля
   - Добавлено логирование уровня WARN для ошибок валидации пароля при смене пароля

**Цель изменений:**
- **Наблюдаемость:** Логирование позволяет отслеживать все важные операции в приложении, что критично для production-окружения
- **Отладка:** Детальное логирование упрощает диагностику проблем и поиск причин ошибок
- **Мониторинг:** Логи можно использовать для мониторинга работы приложения и выявления аномалий
- **Аудит:** Логирование важных операций (регистрация, смена пароля, создание заказов) позволяет отслеживать действия пользователей
- **Производительность:** Использование правильных уровней логирования (DEBUG для деталей, INFO для важных событий, WARN для предупреждений) позволяет контролировать объем логов

**Diff:**

```diff
--- a/ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/impl/AdminServiceImpl.java
+++ b/ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/impl/AdminServiceImpl.java
@@ -17,6 +17,7 @@
 import com.gmail.v.c.charkin.gurmanfood.service.FileService;
 import lombok.RequiredArgsConstructor;
+import lombok.extern.slf4j.Slf4j;
 import org.springframework.data.domain.Page;
@@ -28,6 +29,7 @@
 import java.io.IOException;
 
+@Slf4j
 @Service
 @RequiredArgsConstructor
 public class AdminServiceImpl implements AdminService {
@@ -81,7 +83,9 @@
     @Override
     @Transactional
     public MessageResponse editShawarma(ShawarmaRequest shawarmaRequest, MultipartFile file) throws IOException {
+        log.info("Editing shawarma with ID: {}", shawarmaRequest.getId());
         MessageResponse response = saveShawarma(shawarmaRequest, file, SuccessMessage.SHAWARMA_EDITED);
+        log.info("Shawarma edited successfully. ID: {}", shawarmaRequest.getId());
         return response;
     }
 
@@ -89,7 +93,9 @@
     @Transactional
     public MessageResponse addShawarma(ShawarmaRequest shawarmaRequest, MultipartFile file) throws IOException {
+        log.info("Adding new shawarma: {}", shawarmaRequest.getShawarmaTitle());
         MessageResponse response = saveShawarma(shawarmaRequest, file, SuccessMessage.SHAWARMA_ADDED);
+        log.info("Shawarma added successfully. Title: {}", shawarmaRequest.getShawarmaTitle());
         return response;
     }
```

Примеры для других сервисов (OrderServiceImpl):
```diff
--- a/ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/impl/OrderServiceImpl.java
+++ b/ShawarmaShop/src/main/java/com/gmail/v/c/charkin/gurmanfood/service/impl/OrderServiceImpl.java
@@ -11,6 +11,7 @@
 import com.gmail.v.c.charkin.gurmanfood.service.OrderService;
 import com.gmail.v.c.charkin.gurmanfood.service.UserService;
 import lombok.RequiredArgsConstructor;
+import lombok.extern.slf4j.Slf4j;
 import org.springframework.data.domain.Page;
@@ -23,6 +24,7 @@
 import java.util.Map;
 
+@Slf4j
 @Service
 @RequiredArgsConstructor
 public class OrderServiceImpl implements OrderService {
@@ -51,7 +53,12 @@
     @Override
     @Transactional
     public Long postOrder(User user, OrderRequest orderRequest) {
+        log.info("Creating new order for user: {}", user.getEmail());
         Order order = dtoMapper.mapToOrder(orderRequest);
         order.setUser(user);
         order.getShawarmas().addAll(user.getShawarmaList());
         orderRepository.save(order);
+        log.info("Order created successfully. Order ID: {}, User: {}, Total price: {}", 
+                order.getId(), user.getEmail(), order.getTotalPrice());
         user.getShawarmaList().clear();
+        log.debug("Cart cleared for user: {}", user.getEmail());
```

**Результат:** Добавлено структурированное логирование во все ключевые сервисы приложения. Используются правильные уровни логирования (INFO для важных операций, DEBUG для деталей, WARN для предупреждений). Это значительно улучшает наблюдаемость приложения, упрощает отладку и позволяет эффективно мониторить работу системы в production-окружении.